<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Edinburgh Carbon Intelligence - Research on carbon storage potential in Edinburgh's graveyards. Interactive map and detailed analysis of environmental and social deprivation.">
    <meta name="keywords" content="Edinburgh, carbon storage, graveyards, environmental research, GeoSciences, University of Edinburgh">
    <meta name="author" content="University of Edinburgh - School of GeoSciences">
    <meta property="og:title" content="Edinburgh Carbon Intelligence">
    <meta property="og:description" content="What graveyards tell us about carbon and communities">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/png" href="/dev/group1project/static/report_images/University_of_Edinburgh_Coat_of_Arm.png">
    <title>Edinburgh Carbon Intelligence - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
         :root {
            --bg-dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.95);
            --neon-blue: #0ea5e9;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-purple: #8b5cf6;
            --neon-yellow: #f59e0b;
            --text: #f1f5f9;
            --border: rgba(148, 163, 184, 0.2);
        }
        
        * {
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        /* Back to Top Button */
        
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #e94560;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background: #d63850;
            transform: translateY(-3px);
        }
        
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow-x: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        /* Loading Spinner */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.98);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            font-family: 'Rajdhani';
            font-size: 18px;
            color: var(--neon-blue);
        }
        
        .sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            bottom: 20px;
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(-420px);
        }
        
        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .sidebar-toggle:hover {
            background: rgba(14, 165, 233, 0.2);
        }
        
        .header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            font-family: 'Rajdhani';
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-transform: uppercase;
            background: linear-gradient(135deg, #fff 0%, var(--neon-blue) 50%, var(--neon-purple) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0%,
            100% {
                filter: hue-rotate(0deg);
            }
            50% {
                filter: hue-rotate(10deg);
            }
        }
        
        .header p {
            margin: 8px 0 0;
            font-size: 13px;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }
        /* Legend */
        
        .legend {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 15px;
            justify-content: space-around;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        /* Stats Panel */
        
        .stats-panel {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-family: 'Rajdhani';
            font-size: 20px;
            font-weight: 700;
            color: var(--neon-blue);
        }
        
        .stat-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            margin-top: 4px;
        }
        /* Search Box */
        
        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            outline: none;
            font-size: 13px;
            transition: 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .search-input::placeholder {
            color: #64748b;
        }
        
        .controls {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .mode-btn {
            padding: 12px 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(14, 165, 233, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .mode-btn:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .mode-btn.active {
            background: rgba(14, 165, 233, 0.2);
            color: var(--neon-blue);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }
        
        .list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .list-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .list-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        .list-container::-webkit-scrollbar-thumb:hover {
            background: var(--neon-blue);
        }
        
        .list-item {
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .list-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .item-sub {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 8px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .simulator {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border);
        }
        
        .sim-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--neon-green);
            margin-bottom: 10px;
        }
        
        input[type=range] {
            width: 100%;
            accent-color: var(--neon-green);
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.98);
            color: #fff;
            border: 2px solid var(--neon-blue);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            padding: 0;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(14, 165, 233, 0.3);
        }
        
        .leaflet-popup-content {
            margin: 0;
            width: 320px !important;
        }
        
        .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .leaflet-container a.leaflet-popup-close-button {
            color: #fff;
            font-size: 18px;
            top: 5px;
            right: 5px;
        }
        
        .popup-img-container {
            width: 100%;
            height: 140px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }
        
        .popup-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .popup-img:hover {
            transform: scale(1.1);
        }
        
        .popup-info {
            padding: 20px;
        }
        
        .popup-header {
            font-family: 'Rajdhani';
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 15px 0;
        }
        
        .popup-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .popup-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .popup-stat-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .popup-stat-value {
            font-family: 'Rajdhani';
            font-size: 18px;
            font-weight: 700;
            margin-top: 4px;
        }
        /* Export Button */
        
        .export-btn {
            position: absolute;
            bottom: 160px;
            right: 20px;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .export-btn:hover {
            background: rgba(14, 165, 233, 0.2);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        
        .tag {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }
        
        .tag.priority {
            border-color: var(--neon-red);
            color: var(--neon-red);
            background: rgba(239, 68, 68, 0.15);
        }
        
        .tag.biodiversity {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .tag.heritage {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .tag.highest {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
            background: rgba(14, 165, 233, 0.15);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        /* Legend on map */
        
        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            min-width: 150px;
        }
        
        .map-legend-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            color: var(--neon-blue);
        }
        
        .legend-item-map {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            margin-bottom: 6px;
        }
        
        .legend-color-map {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        /* Graveyard number labels */
        
        .graveyard-number-label {
            background: transparent;
        }
        
        .number-marker {
            width: 24px;
            height: 24px;
            background: rgba(14, 165, 233, 0.9);
            border: 2px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .number-marker:hover {
            transform: scale(1.2);
            background: rgba(139, 92, 246, 0.9);
        }
        /* Priority highlight for list items */
        
        .list-item.priority-site {
            border-left-color: var(--neon-red);
            background: rgba(239, 68, 68, 0.08);
        }
        
        .list-item.highest-edi {
            border-left-color: var(--neon-blue);
            background: rgba(14, 165, 233, 0.08);
        }
        /* Report Page Styles */
        
        #report-page {
            display: block;
        }
        
        #report-page.hidden {
            display: none;
        }
        
        #map-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #map-page.active {
            display: block;
        }
        /* Hide sidebar when report page is shown - controlled by JavaScript */
        
        .sidebar.hidden {
            display: none;
        }
        /* Report Navigation */
        
        .report-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(16, 185, 129, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 0;
            transition: box-shadow 0.3s, background 0.3s;
        }
        
        .report-nav.scrolled {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            background: rgba(16, 185, 129, 0.98);
        }
        /* Mobile Responsive */
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                height: 50vh;
                border-radius: 16px 16px 0 0;
            }
            .sidebar.collapsed {
                transform: translateY(calc(50vh - 60px));
            }
            .export-btn {
                bottom: auto;
                top: 20px;
            }
        }
        
        .report-nav-inner {
            max-width: 100%;
            margin: 0;
            padding: 0 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .report-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
        }
        
        .report-logo img {
            height: 250px;
        }
        
        .report-logo-text {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .report-nav-links {
            display: flex;
            gap: 30px;
        }
        
        .report-nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            padding: 8px 14px;
            border-radius: 20px;
            position: relative;
        }
        
        .report-nav-links a:hover {
            color: #1e3a5f;
            background: rgba(255, 255, 255, 0.95);
            text-shadow: none;
            transform: translateY(-2px);
        }
        
        .report-nav-links a.active {
            color: #1e3a5f;
            background: #fff;
            text-shadow: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        
        .report-nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .report-nav-buttons button {
            padding: 10px 15px;
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.5);
            color: rgba(14, 165, 233, 0.7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .report-nav-buttons button:hover {
            background: rgba(14, 165, 233, 0.3);
        }
        
        .report-nav-buttons button.active {
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
        }
        /* Report Page Content */
        
        .report-hero {
            min-height: 100vh;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #2d3436;
            padding: 100px 40px;
            margin-top: 70px;
        }
        
        .report-hero-content {
            max-width: 100%;
            width: 100%;
        }
        
        .report-hero h1 {
            font-family: 'EB Garamond', serif;
            font-size: 56px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #2d3436;
        }
        
        .report-hero .subtitle {
            font-size: 22px;
            color: #2d3436;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .report-hero-image {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }
        
        .report-section {
            padding: 100px 40px;
        }
        
        .report-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .report-section-title {
            font-family: 'EB Garamond', serif;
            font-size: 42px;
            color: #2d3436;
            margin-bottom: 50px;
            text-align: center;
        }
        
        .report-section-title span {
            color: #2d3436;
        }
        
        .report-content-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            align-items: center;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .report-content-card.reverse {
            direction: rtl;
        }
        
        .report-content-card.reverse>* {
            direction: ltr;
        }
        
        .report-card-image {
            height: 100%;
            min-height: 350px;
            position: relative;
            overflow: hidden;
        }
        
        .report-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .report-card-image img:hover {
            transform: scale(1.05);
        }
        
        .report-card-content {
            padding: 40px;
        }
        
        .report-card-content h3 {
            font-family: 'EB Garamond', serif;
            font-size: 28px;
            color: #2d3436;
            margin-bottom: 20px;
        }
        
        .report-card-content p {
            font-size: 15px;
            color: #2d3436;
            margin-bottom: 15px;
        }
        
        .report-card-content ul {
            list-style: none;
            padding: 0;
        }
        
        .report-card-content li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-card-content li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 14px;
            width: 8px;
            height: 8px;
            background: #2d3436;
            border-radius: 50%;
        }
        
        .report-key-points {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 40px;
        }
        
        .report-key-point {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .report-key-point i {
            font-size: 36px;
            color: #e94560;
            margin-bottom: 15px;
        }
        
        .report-key-point h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .report-key-point p {
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        
        .report-stat {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .report-stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .report-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .report-recommendations {
            margin-top: 40px;
        }
        
        .report-rec-item {
            display: flex;
            gap: 20px;
            padding: 25px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .report-rec-number {
            width: 40px;
            height: 40px;
            background: #e94560;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .report-rec-content h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3436;
        }
        
        .report-rec-content p {
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-team-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-top: 40px;
        }
        
        .report-team-member {
            text-align: center;
        }
        
        .report-team-avatar-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 12px;
            border: 3px solid #f8f9fa;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .report-team-member h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #2d3436;
        }
        
        .report-team-member p {
            font-size: 12px;
            color: #2d3436;
        }
        
        .report-footer {
            background: #a7f3d0;
            color: #000;
            padding: 10px 40px;
        }
        
        .report-footer-inner {
            max-width: 100%;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .report-footer-form h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .report-footer-form input,
        .report-footer-form textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }
        
        .report-footer-form input::placeholder,
        .report-footer-form textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .report-footer-form textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .report-footer-form button {
            padding: 10px 25px;
            background: #e94560;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .report-footer-form button:hover {
            background: #d63850;
        }
        
        .report-footer-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .report-footer-brand img {
            height: 80px !important;
            min-height: 80px !important;
        }
        
        .report-footer-info h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .report-footer-info p {
            font-size: 13px;
            opacity: 0.7;
        }
        
        .report-footer-contact p {
            font-size: 14px;
            margin: 5px 0;
        }
        
        .report-footer-contact a {
            color: #e94560;
            text-decoration: none;
        }
        
        @media (max-width: 900px) {
            .report-content-card {
                grid-template-columns: 1fr;
            }
            .report-content-card.reverse {
                direction: ltr;
            }
            .report-key-points {
                grid-template-columns: 1fr;
            }
            .report-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .report-team-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .report-team-member {
                text-align: center;
            }
            .report-team-avatar-img {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                object-fit: cover;
                margin: 0 auto 12px;
                border: 3px solid #f8f9fa;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            .report-team-member h4 {
                font-size: 14px;
                margin-bottom: 3px;
                color: #2d3436;
            }
            .report-hero h1 {
                font-size: 36px;
            }
            .report-hero-content>div {
                flex-direction: column !important;
                padding: 0 20px !important;
            }
            .report-hero-content>div img {
                width: 100% !important;
                max-width: 100% !important;
            }
            .report-footer-inner {
                flex-direction: column;
                padding: 0 20px;
            }
            .report-footer-brand img {
                height: 150px;
            }
            .report-footer-form {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Feedback Modal -->
    <div id="feedbackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: #fff; border-radius: 16px; width: 90%; max-width: 700px; height: 85vh; position: relative; overflow: hidden;">
            <div style="background: #10b981; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-comment-dots" style="margin-right: 10px;"></i>Feedback Survey</h3>
                <button onclick="closeFeedbackModal()" style="background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
            </div>
            <iframe src="https://forms.office.com/e/pBS3p5L9Fc" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
        </div>
    </div>

    <script>
        function openFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        document.getElementById('feedbackModal').addEventListener('click', function(e) {
            if (e.target === this) closeFeedbackModal();
        });

        function searchPageContent(query) {
            if (!query || query.length < 2) {
                clearHighlights();
                return;
            }
            clearHighlights();
            var sections = {
                'introduction': '#report-motivation',
                'methods': '#report-methods',
                'results': '#report-results',
                'conclusions': '#report-conclusions',
                'sources': '#report-sources',
                'team': '#report-team',
                'carbon': '#report-intro',
                'deprivation': '#report-results',
                'graveyard': '#report-intro',
                'lidar': '#report-methods',
                'ndvi': '#report-methods',
                'simd': '#report-results'
            };
            var lowerQuery = query.toLowerCase();
            for (var key in sections) {
                if (key.includes(lowerQuery)) {
                    var target = document.querySelector(sections[key]);
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                        target.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.5)';
                        setTimeout(function() {
                            target.style.boxShadow = '';
                        }, 2000);
                        return;
                    }
                }
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.report-section').forEach(function(el) {
                el.style.boxShadow = '';
            });
        }

        // Scroll Spy - ڨ��خSM���*��
        function updateActiveNav() {
            var sections = document.querySelectorAll('.report-section, .report-hero');
            var navLinks = document.querySelectorAll('.report-nav-links a[href^="#"]');
            var scrollPos = window.scrollY + 150;

            sections.forEach(function(section) {
                var top = section.offsetTop;
                var height = section.offsetHeight;
                var id = section.getAttribute('id');

                if (scrollPos >= top && scrollPos < top + height) {
                    navLinks.forEach(function(link) {
                        link.classList.remove('active');
                        var href = link.getAttribute('href');
                        if (href === '#' + id) {
                            link.classList.add('active');
                        }
                    });
                }
            });

            // Hero:�y�
            if (window.scrollY < 300) {
                navLinks.forEach(function(link) {
                    link.classList.remove('active');
                });
                var introLink = document.querySelector('.report-nav-links a[href="#report-motivation"]');
                if (introLink) introLink.classList.add('active');
            }
        }

        // �,ڨ��
        window.addEventListener('scroll', updateActiveNav);
        // ub�}��
        document.addEventListener('DOMContentLoaded', updateActiveNav);

        // Toggle Help Panel
        function toggleHelp() {
            var panel = document.getElementById('helpPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }
    </script>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Edinburgh Graveyard Data...</div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>

        <div class="header">
            <h1>City Cemetery Carbon</h1>
            <p>Explore Edinburgh's secret carbon sinks</p>
            <button onclick="toggleHelp()" style="width: 100%; margin-top: 10px; padding: 8px; background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;"><i class="fas fa-question-circle" style="margin-right: 6px;"></i>How to Use</button>
            <div id="helpPanel" style="display: none; margin-top: 10px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; font-size: 11px; color: #94a3b8; line-height: 1.6;">
                <p style="margin-bottom: 8px;"><strong style="color: #10b981;">Quick Guide:</strong></p>
                <p><i class="fas fa-mouse-pointer" style="width: 16px;"></i> Select graveyard on map or list below</p>
                <p><i class="fas fa-palette" style="width: 16px;"></i> Click data buttons to change display</p>
                <p><i class="fas fa-filter" style="width: 16px;"></i> Filter results by total carbon</p>
                <p><i class="fas fa-search" style="width: 16px;"></i> Search by name or postcode</p>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="switchPage('report')" id="btn-report" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.5); color: rgba(139, 92, 246, 0.7); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;"
                    onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                    <i class="fa-solid fa-book-open"></i> Read Our Study
                </button>
            </div>
        </div>

        <!-- View Mode Controls -->
        <div class="controls" style="grid-template-columns: repeat(2, 1fr);">
            <button class="mode-btn active" onclick="setMode('carbon')" title="Carbon storage per hectare (tonnes/ha) - Shows carbon density of each graveyard"><i class="fa-solid fa-leaf"></i> Carbon/Ha</button>
            <button class="mode-btn" onclick="setMode('agb')" title="Total carbon stored in vegetation (tonnes)"><i class="fa-solid fa-seedling"></i> Total Carbon</button>
            <button class="mode-btn" onclick="setMode('canopy')" title="Canopy Cover Percentage - Tree canopy coverage of each site"><i class="fa-solid fa-tree"></i> Canopy %</button>
            <button class="mode-btn" onclick="setMode('edi')" title="Environmental Deprivation Index - LOW scores = HIGH environmental deprivation, HIGH scores = LOW environmental deprivation"><i class="fa-solid fa-tree"></i> EDI</button>
            <button class="mode-btn" onclick="setMode('ndvi')" title="Normalized Difference Vegetation Index - Satellite-derived vegetation greenness (0-1)"><i class="fa-solid fa-spa"></i> NDVI</button>
            <button class="mode-btn" onclick="setMode('simd')" title="Scottish Index of Multiple Deprivation - Neighbourhood deprivation level (1=most deprived, 10=least)"><i class="fa-solid fa-house-user"></i> SIMD Decile</button>
            <button class="mode-btn" onclick="setMode('strata')" title="Tree Cover Classification - High/Medium/Low tree coverage category"><i class="fa-solid fa-layer-group"></i> Tree Cover</button>
        </div>

        <!-- Edinburgh SIMD Background Toggle -->
        <div style="padding: 15px 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">City-wide SIMD</div>
            <button id="simd-bg-btn" onclick="toggleSIMDBackground()" title="Toggle city-wide SIMD background layer showing neighbourhood deprivation across Edinburgh" style="width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;">
                <i class="fa-solid fa-layer-group"></i> Neighbourhood Social Deprivation
            </button>
        </div>

        <!-- Advanced Filters -->
        <div style="padding: 15px 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 10px; font-weight: 600;">Advanced Filters</div>
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 6px;">Carbon Range (t)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="carbon-min" value="0" style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;">
                    <span style="color: #64748b;">-</span>
                    <input type="number" id="carbon-max" value="200" style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;">
                </div>
            </div>
            <button onclick="applyFilters()" style="width: 100%; padding: 8px; background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">Apply Filters</button>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">35</div>
                <div class="stat-label">Total Sites</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-carbon">--</div>
                <div class="stat-label">Total Carbon (t)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-edi">--</div>
                <div class="stat-label">Avg EDI</div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="search-input" placeholder="Name or Postcode (e.g. EH1 1QS)" oninput="filterList()">
        </div>

        <!-- List Container -->
        <div class="list-container" id="list"></div>

    </div>

    <div id="map-page">
        <div id="map"></div>

        <!-- Legend on Map -->
        <div class="map-legend" id="map-legend">
            <div class="map-legend-title">Legend</div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-1" style="background: #059669;"></div>
                <span id="legend-map-1-text">High</span>
            </div>
            <div class="legend-item-map" id="legend-item-2" style="display: none;">
                <div class="legend-color-map" id="legend-map-2" style="background: #10b981;"></div>
                <span id="legend-map-2-text">Medium-High</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-3" style="background: #10b981;"></div>
                <span id="legend-map-3-text">Medium</span>
            </div>
            <div class="legend-item-map" id="legend-item-4" style="display: none;">
                <div class="legend-color-map" id="legend-map-4" style="background: #6ee7b7;"></div>
                <span id="legend-map-4-text">Medium-Low</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-5" style="background: #6ee7b7;"></div>
                <span id="legend-map-5-text">Low</span>
            </div>
        </div>

        <!-- SIMD Background Legend -->
        <div class="map-legend" id="simd-legend" style="display: none; bottom: 250px;">
            <div class="map-legend-title">SIMD Deprivation</div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #ea580c;"></div>
                <span>Most Deprived (1-2)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #f97316;"></div>
                <span>High (3-4)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #fbbf24;"></div>
                <span>Medium (5-6)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #fde047;"></div>
                <span>Low (7-8)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #fef9c3;"></div>
                <span>Least Deprived (9-10)</span>
            </div>
        </div>
    </div>

    <!-- Report Page -->
    <div id="report-page">
        <!-- Report Navigation -->
        <nav class="report-nav" id="reportNav">
            <div class="report-nav-inner">
                <div class="report-logo">
                    <img src="/dev/group1project/static/report_images/University_of_Edinburgh_Coat_of_Arm.png" alt="University of Edinburgh">
                    <span class="report-logo-text">Carbon Research</span>
                </div>
                <div style="position: relative;">
                    <input type="text" id="navSearchInput" placeholder="Search content..." oninput="searchPageContent(this.value)" style="padding: 8px 35px 8px 12px; border: none; border-radius: 20px; font-size: 13px; width: 180px; background: rgba(255,255,255,0.9); color: #333;">
                    <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-size: 12px;"></i>
                </div>
                <div class="report-nav-links">
                    <a href="#report-motivation">Introduction</a>
                    <a href="#report-methods">Methods</a>
                    <a href="#report-results">Results</a>
                    <a href="#report-conclusions">Conclusions</a>
                    <a href="#report-sources">Sources</a>
                    <a href="#report-team">Team</a>
                    <a href="#" onclick="switchPage('map'); return false;" style="color: #000; font-weight: 700; margin-right: 20px;">Interactive Map</a>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="report-hero">
            <div class="report-hero-content">
                <h1>Edinburgh's Cemeteries Carbon Storage</h1>
                <p class="subtitle">Tourism, biodiversity and wellbeing are just some of the benefits of graveyards, but what about carbon storage?</p>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 30px; margin-bottom: 40px;">
                    <a href="#" onclick="openFeedbackModal(); return false;" style="color: #2d3436; text-decoration: none; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; padding: 15px 30px; border: 2px solid #2d3436; border-radius: 4px; transition: all 0.3s;"
                        onmouseover="this.style.background='#2d3436'; this.style.color='#fff'" onmouseout="this.style.background='transparent'; this.style.color='#2d3436'">GET INVOLVED</a>
                    <a href="#" onclick="switchPage('map'); return false;" style="color: #2d3436; text-decoration: none; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; padding: 15px 30px; border: 2px solid #2d3436; border-radius: 4px; transition: all 0.3s;"
                        onmouseover="this.style.background='#2d3436'; this.style.color='#fff'" onmouseout="this.style.background='transparent'; this.style.color='#2d3436'">INTERACTIVE WEBMAP</a>
                </div>
            </div>
        </section>
        <section id="report-motivation" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">The Motivation of <span>Our Study</span></h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: stretch;">
                    <div style="text-align: left; display: flex; flex-direction: column; justify-content: space-between; padding: 15px 0;">
                        <p style="font-size: 20px; font-weight: 700; color: #2d3436; margin: 0; line-height: 1.5;">In 2022, Edinburgh produced 2,192 thousand tonnes of CO<sub>2</sub> equivalent.</p>
                        <p style="font-size: 16px; color: #2d3436; margin: 0; line-height: 1.8;">The city of Edinburgh has promised to be a net-zero city by 2030, which included the aim to 'sequester carbon where possible'.</p>
                        <p style="font-size: 16px; color: #2d3436; margin: 0; line-height: 1.8;">A study in London found urban graveyards can store as much carbon per hectare as temperate and tropical forests so, can Edinburgh's graveyards do the same?</p>
                        <p style="font-size: 16px; color: #2d3436; line-height: 1.8;">Our study investigates the above ground carbon storage across 35 cemeteries in Edinburgh, with the aim to either prove or disprove their value as a carbon sink. Then, compare carbon values to our own environmental deprivation index
                            (EDI) and the Scottish index of multiple deprivation (SIMD) to identify priority areas that can be enhanced, protected and restored.</p>
                    </div>
                    <div>
                        <img src="/dev/group1project/static/report_images/image1.jpg" alt="Edinburgh Cemetery" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                </div>
            </div>
        </section>

        <!-- Research Questions -->
        <section id="report-intro" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Questions</span></h2>
                <div class="report-key-points">
                    <div class="report-key-point">
                        <i class="fas fa-leaf"></i>
                        <h4>Carbon Storage</h4>
                        <p>What is the above-ground carbon storage of Edinburgh's graveyards?</p>
                    </div>
                    <div class="report-key-point">
                        <i class="fas fa-balance-scale"></i>
                        <h4>Environmental Deprivation</h4>
                        <p>Can carbon storage inform a new measure of environmental deprivation?</p>
                    </div>
                    <div class="report-key-point">
                        <i class="fas fa-bullseye"></i>
                        <h4>Priority Greenspaces</h4>
                        <p>Can carbon stocks and environmental deprivation identify priority greenspaces for enhancement funds?</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Methods -->
        <section id="report-methods" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">Our <span>Methods</span></h2>

                <!-- Method Tabs -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap;">
                    <button onclick="showMethodTab(1)" id="method-tab-1" style="padding: 15px 30px; border: none; background: linear-gradient(135deg, #1e3a5f, #0891b2); color: #fff; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3); display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tree"></i> Collecting Ground Data
                    </button>
                    <button onclick="showMethodTab(2)" id="method-tab-2" style="padding: 15px 30px; border: 2px solid #1e3a5f; background: #fff; color: #1e3a5f; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-satellite"></i> Upscaling with Satellites
                    </button>
                    <button onclick="showMethodTab(3)" id="method-tab-3" style="padding: 15px 30px; border: 2px solid #1e3a5f; background: #fff; color: #1e3a5f; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calculator"></i> Our EDI
                    </button>
                </div>

                <!-- Tab 1: Collecting Ground Data -->
                <div id="method-content-1" style="display: block;">
                    <div class="report-content-card" style="grid-template-columns: 1fr; gap: 20px;">
                        <div class="report-card-content" style="padding: 30px;">
                            <h3 style="font-size: 24px; color: #1e3a5f; margin-bottom: 15px;">Collecting Ground Data</h3>
                            <p style="font-size: 16px; line-height: 1.8;">Fieldwork was conducted at 9 different graveyards, which were split into three categories: low, medium, and high tree cover. These were classified using satellite imagery like the ones shown below:</p>
                        </div>
                        <p style="font-size: 14px; color: #636e72; margin-bottom: 10px; text-align: center; padding: 0 30px;"><i class="fas fa-hand-pointer" style="margin-right: 8px;"></i>Click each image to flip between satellite view and field photo</p>
                        <div style="display: flex; justify-content: space-evenly; align-items: flex-start; padding: 0 30px 20px; gap: 15px;">
                            <!-- Flip Card 1: Low tree cover -->
                            <div class="flip-card" onclick="flipCard(this)" style="width: 30%; cursor: pointer; perspective: 1000px;">
                                <div class="flip-card-inner" style="position: relative; width: 100%; height: 280px; transition: transform 0.6s; transform-style: preserve-3d;">
                                    <div class="flip-card-front" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image4.png" alt="Low tree cover - Satellite" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-satellite"></i> Low Tree Cover
                                        </div>
                                    </div>
                                    <div class="flip-card-back" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image3.jpg" alt="Low tree cover - Field" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-camera"></i> Field Photo
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Flip Card 2: Medium tree cover -->
                            <div class="flip-card" onclick="flipCard(this)" style="width: 30%; cursor: pointer; perspective: 1000px;">
                                <div class="flip-card-inner" style="position: relative; width: 100%; height: 280px; transition: transform 0.6s; transform-style: preserve-3d;">
                                    <div class="flip-card-front" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image5.png" alt="Medium tree cover - Satellite" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-satellite"></i> Medium Tree Cover
                                        </div>
                                    </div>
                                    <div class="flip-card-back" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image6.jpg" alt="Medium tree cover - Field" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-camera"></i> Field Photo
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Flip Card 3: High tree cover -->
                            <div class="flip-card" onclick="flipCard(this)" style="width: 30%; cursor: pointer; perspective: 1000px;">
                                <div class="flip-card-inner" style="position: relative; width: 100%; height: 280px; transition: transform 0.6s; transform-style: preserve-3d;">
                                    <div class="flip-card-front" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image8.png" alt="High tree cover - Satellite" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-satellite"></i> High Tree Cover
                                        </div>
                                    </div>
                                    <div class="flip-card-back" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); border-radius: 8px; overflow: hidden;">
                                        <img src="/dev/group1project/static/report_images/image7.jpg" alt="High tree cover - Field" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 10px; color: #fff; font-size: 12px;">
                                            <i class="fas fa-camera"></i> Field Photo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="padding: 0 30px 30px; color: #2d3436; font-size: 16px; line-height: 1.8;">63 plots, with a radius of 5m, were taken across these 9 graveyards and chosen using stratified random sampling. Tree species, condition, and DBH (diameter at breast height) were recorded for each tree found in these plots. These
                            values were then input into equations to calculate the above-ground biomass, which is then used to calculate carbon content.</p>
                    </div>
                </div>

                <!-- Tab 2: Upscaling with Satellites -->
                <div id="method-content-2" style="display: none;">
                    <div class="report-content-card" style="grid-template-columns: 1fr; gap: 20px;">
                        <div class="report-card-content" style="padding: 30px;">
                            <h3 style="font-size: 24px; color: #1e3a5f; margin-bottom: 15px;">Upscaling Ground Data Using Satellites</h3>
                            <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px;">Scottish Government LiDAR satellite data let us calculate the average tree height at each cemetery. Combining this data with field measurements, we could scale our carbon estimates city-wide.</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: #fff; padding: 20px; border-radius: 12px; border-left: 4px solid #1e3a5f;">
                                    <h4 style="color: #1e3a5f; margin-bottom: 10px;"><i class="fas fa-chart-line" style="margin-right: 8px;"></i>Calibration</h4>
                                    <p style="font-size: 14px; color: #636e72; line-height: 1.7;">70% of field data was plotted on a graph to establish the relationship between canopy height and carbon density (carbon in tonnes per hectare, or Mg/ha).</p>
                                </div>
                                <div style="background: #fff; padding: 20px; border-radius: 12px; border-left: 4px solid #0891b2;">
                                    <h4 style="color: #0891b2; margin-bottom: 10px;"><i class="fas fa-check-circle" style="margin-right: 8px;"></i>Validation</h4>
                                    <p style="font-size: 14px; color: #636e72; line-height: 1.7;">The remaining data was plotted in another graph to test the calibration model's accuracy.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Our EDI -->
                <div id="method-content-3" style="display: none;">
                    <div class="report-content-card" style="grid-template-columns: 1fr; gap: 20px;">
                        <div class="report-card-content" style="padding: 30px;">
                            <h3 style="font-size: 24px; color: #1e3a5f; margin-bottom: 15px;">Our EDI</h3>
                            <p style="font-size: 16px; line-height: 1.8; margin-bottom: 25px;">To represent environmental deprivation, we combined the calculated carbon values with tree height and canopy cover from LiDAR data and NDVI (vegetation health) data from the Sentinel-2 satellite like this:</p>
                            <div style="text-align: center; margin-bottom: 25px;">
                                <img src="/dev/group1project/static/report_images/image11.png" alt="EDI Formula" style="max-width: 100%; height: auto; border-radius: 8px; cursor: pointer;" onclick="openImageModal(this.src)">
                            </div>
                            <p style="font-size: 16px; line-height: 1.8; color: #2d3436;">These results were then ranked and compared to SIMD to help identify priority areas. <strong>Low scores show high environmental deprivation</strong> and <strong>high scores show low environmental deprivation</strong>.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script>
            function showMethodTab(tabNum) {
                for (var i = 1; i <= 3; i++) {
                    document.getElementById('method-content-' + i).style.display = 'none';
                    var tab = document.getElementById('method-tab-' + i);
                    tab.style.background = '#fff';
                    tab.style.color = '#1e3a5f';
                    tab.style.border = '2px solid #1e3a5f';
                    tab.style.boxShadow = '0 2px 10px rgba(0,0,0,0.05)';
                }
                document.getElementById('method-content-' + tabNum).style.display = 'block';
                var activeTab = document.getElementById('method-tab-' + tabNum);
                activeTab.style.background = 'linear-gradient(135deg, #1e3a5f, #0891b2)';
                activeTab.style.color = '#fff';
                activeTab.style.border = 'none';
                activeTab.style.boxShadow = '0 4px 15px rgba(30, 58, 95, 0.3)';
            }

            function switchFieldImage(src) {
                document.getElementById('field-main-image').src = src;
                // Update thumbnail borders
                var thumbs = document.querySelectorAll('#method-content-1 [onclick*="switchFieldImage"]');
                thumbs.forEach(function(thumb) {
                    if (thumb.src === src) {
                        thumb.style.border = '3px solid #1e3a5f';
                    } else {
                        thumb.style.border = '3px solid transparent';
                    }
                });
            }

            function flipCard(card) {
                var inner = card.querySelector('.flip-card-inner');
                if (inner.style.transform === 'rotateY(180deg)') {
                    inner.style.transform = 'rotateY(0deg)';
                } else {
                    inner.style.transform = 'rotateY(180deg)';
                }
            }
        </script>

        <!-- Results -->
        <section id="report-results" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Results</span></h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center;">
                    <!-- Left: Image Carousel -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <!-- Left Arrow -->
                            <button onclick="changeResultsSlide(-1)" style="background: rgba(45,106,79,0.1); border: 2px solid #2d6a4f; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; color: #2d6a4f; flex-shrink: 0; transition: all 0.3s;" onmouseover="this.style.background='#2d6a4f'; this.style.color='#fff'"
                                onmouseout="this.style.background='rgba(45,106,79,0.1)'; this.style.color='#2d6a4f'">
                                <i class="fas fa-chevron-left"></i>
                            </button>

                            <!-- Image Container -->
                            <div style="position: relative; flex: 1; overflow: hidden; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                                <!-- Page Counter Top-Left -->
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 12px; z-index: 10; font-weight: 600;">
                                    <span id="results-slide-counter">1</span> / 5
                                </div>
                                <img id="results-slide-1" src="/dev/group1project/static/report_images/image.65.png" alt="Calibration" style="width: 100%; display: block; cursor: pointer;" onclick="openImageModal(this.src)">
                                <img id="results-slide-2" src="/dev/group1project/static/report_images/image.66.png" alt="Validation" style="width: 100%; display: none; cursor: pointer;" onclick="openImageModal(this.src)">
                                <img id="results-slide-3" src="/dev/group1project/static/report_images/image13.png" alt="Calibration vs Validation" style="width: 100%; display: none; cursor: pointer;" onclick="openImageModal(this.src)">
                                <img id="results-slide-4" src="/dev/group1project/static/report_images/image64.png" alt="EDI Rankings Table" style="width: 100%; display: none; cursor: pointer;" onclick="openImageModal(this.src)">
                                <img id="results-slide-5" src="/dev/group1project/static/report_images/image15.png" alt="SIMD & EDI Map" style="width: 100%; display: none; cursor: pointer;" onclick="openImageModal(this.src)">
                            </div>

                            <!-- Right Arrow -->
                            <button onclick="changeResultsSlide(1)" style="background: rgba(45,106,79,0.1); border: 2px solid #2d6a4f; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; color: #2d6a4f; flex-shrink: 0; transition: all 0.3s;" onmouseover="this.style.background='#2d6a4f'; this.style.color='#fff'"
                                onmouseout="this.style.background='rgba(45,106,79,0.1)'; this.style.color='#2d6a4f'">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <p id="results-caption" style="text-align: left; font-size: 14px; color: #555; margin-top: 15px; font-style: italic;">Figure 1. Calibration model showing relationship between canopy height and carbon density.</p>
                    </div>

                    <!-- Right: Numbered Dropdown Headings -->
                    <div>
                        <p style="font-size: 12px; color: #2d6a4f; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; margin-bottom: 10px;">FINDINGS</p>
                        <h3 id="results-title" style="font-size: 28px; color: #2d3436; font-weight: 700; margin-bottom: 30px; line-height: 1.3;">Results Show Carbon Storage Potential</h3>

                        <!-- Item 1 -->
                        <div style="border-bottom: 1px solid #e0e0e0; padding: 15px 0;">
                            <button onclick="toggleResultsDropdown(1)" style="display: flex; align-items: center; gap: 15px; width: 100%; background: none; border: none; cursor: pointer; text-align: left;">
                                <span id="results-num-1" style="min-width: 32px; height: 32px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: #666; transition: all 0.3s;">1</span>
                                <span id="results-title-1" style="font-size: 18px; font-weight: 700; color: #2d3436;">Calibration and Validation</span>
                            </button>
                            <div id="results-dropdown-1" style="display: none; padding: 15px 0 5px 47px; color: #555; font-size: 15px; line-height: 1.8;">
                                Calibration and validation models show the bias and accuracy (RMSE) of the predicted and observed results.<br><br> Both models show a weak positive relationship, with the calibration model showing a higher RMSE, suggesting
                                errors took place during fieldwork, which lead to errors in the predictive results from LiDAR.<br><br> When compared together, you can see that calibration carbon estimates are often twice as high as validation estimates.
                            </div>
                        </div>

                        <!-- Item 2 -->
                        <div style="border-bottom: 1px solid #e0e0e0; padding: 15px 0;">
                            <button onclick="toggleResultsDropdown(2)" style="display: flex; align-items: center; gap: 15px; width: 100%; background: none; border: none; cursor: pointer; text-align: left;">
                                <span id="results-num-2" style="min-width: 32px; height: 32px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: #666; transition: all 0.3s;">2</span>
                                <span id="results-title-2" style="font-size: 18px; font-weight: 700; color: #2d3436; transition: all 0.3s;">EDI Rankings</span>
                            </button>
                            <div id="results-dropdown-2" style="display: none; padding: 15px 0 5px 47px; color: #555; font-size: 15px; line-height: 1.8;">
                                These are the 5 cemeteries that have the lowest EDI score according to our equation.
                            </div>
                        </div>

                        <!-- Item 3 -->
                        <div style="padding: 15px 0;">
                            <button onclick="toggleResultsDropdown(3)" style="display: flex; align-items: center; gap: 15px; width: 100%; background: none; border: none; cursor: pointer; text-align: left;">
                                <span id="results-num-3" style="min-width: 32px; height: 32px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: #666; transition: all 0.3s;">3</span>
                                <span id="results-title-3" style="font-size: 18px; font-weight: 700; color: #2d3436;">SIMD and EDI</span>
                            </button>
                            <div id="results-dropdown-3" style="display: none; padding: 15px 0 5px 47px; color: #555; font-size: 15px; line-height: 1.8;">
                                There is no strong spatial relationship between our EDI and SIMD. None of the 15 most environmentally deprived cemeteries are situated in a highly deprived neighbourhood, apart from Buccleuch cemetery.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script>
            var currentResultsSlide = 1;
            var resultsCaptions = [
                'Figure 1. Calibration model showing relationship between canopy height and carbon density.',
                'Figure 2. Validation model testing accuracy using remaining field data.',
                'Figure 3. Calibration vs Validation comparison of carbon estimates.',
                'Figure 4. EDI Rankings showing the 5 cemeteries with lowest environmental scores.',
                'Figure 5. SIMD and EDI spatial analysis map of Edinburgh graveyards.'
            ];

            function changeResultsSlide(direction) {
                document.getElementById('results-slide-' + currentResultsSlide).style.display = 'none';
                currentResultsSlide += direction;
                if (currentResultsSlide > 5) currentResultsSlide = 1;
                if (currentResultsSlide < 1) currentResultsSlide = 5;
                document.getElementById('results-slide-' + currentResultsSlide).style.display = 'block';
                document.getElementById('results-slide-counter').textContent = currentResultsSlide;
                document.getElementById('results-caption').textContent = resultsCaptions[currentResultsSlide - 1];
            }

            function toggleResultsDropdown(num) {
                var content = document.getElementById('results-dropdown-' + num);
                var numSpan = document.getElementById('results-num-' + num);
                var titleSpan = document.getElementById('results-title-' + num);
                var isOpen = content.style.display !== 'none';
                content.style.display = isOpen ? 'none' : 'block';
                if (isOpen) {
                    numSpan.style.background = 'transparent';
                    numSpan.style.color = '#666';
                    numSpan.style.border = '2px solid #ccc';
                    titleSpan.style.color = '#2d3436';
                } else {
                    numSpan.style.background = '#2d6a4f';
                    numSpan.style.color = '#fff';
                    numSpan.style.border = '2px solid #2d6a4f';
                    titleSpan.style.color = '#34C759';
                }
            }
        </script>

        <!-- Conclusions -->
        <section id="report-conclusions" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">Our <span>Conclusions</span></h2>

                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; align-items: start;">
                    <!-- Left: Tabs and Content -->
                    <div>
                        <!-- Tab Links -->
                        <div style="margin-bottom: 30px;">
                            <button onclick="showConclusionTab(1)" id="conclusion-tab-1" style="display: block; width: 100%; text-align: left; padding: 12px 0; background: none; border: none; cursor: pointer; font-size: 18px; font-weight: 600; color: #2d6a4f; transition: all 0.3s;">
                                <i class="fas fa-star" style="color: #2d6a4f; margin-right: 10px;"></i> Conclusions
                            </button>
                            <button onclick="showConclusionTab(2)" id="conclusion-tab-2" style="display: block; width: 100%; text-align: left; padding: 12px 0; background: none; border: none; cursor: pointer; font-size: 18px; font-weight: 400; color: #636e72; transition: all 0.3s;">
                                <i class="fas fa-lightbulb" style="margin-right: 10px;"></i> Recommendations
                            </button>
                            <button onclick="showConclusionTab(3)" id="conclusion-tab-3" style="display: block; width: 100%; text-align: left; padding: 12px 0; background: none; border: none; cursor: pointer; font-size: 18px; font-weight: 400; color: #636e72; transition: all 0.3s;">
                                <i class="fas fa-exclamation-circle" style="margin-right: 10px;"></i> Limitations & Challenges
                            </button>
                        </div>

                        <!-- Content Areas -->
                        <div id="conclusion-content-1" style="display: block;">
                            <h4 style="font-size: 20px; color: #2d3436; margin-bottom: 20px; font-weight: 600;">Overall Conclusions</h4>
                            <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;">Our study shows inconclusive results and cannot demonstrate that Edinburgh's graveyards serve as important carbon sinks due to the unreliable ground data.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;">Spatial analysis showed a minimal alignment between environmental and social deprivation, due to the uncertainty affecting our EDI equation, these results are inaccurate.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;">Field observations confirmed the cultural, recreational and biodiversity benefits of graveyards.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8;">The methods used are promising, if more robust fieldwork takes place.</li>
                            </ul>
                        </div>
                        <div id="conclusion-content-2" style="display: none;">
                            <h4 style="font-size: 20px; color: #2d3436; margin-bottom: 20px; font-weight: 600;">Recommendations</h4>
                            <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;"><strong>Invest where there will be the greatest impact</strong><br>Using SIMD, prioritise greenspace funding in social deprivation hotspots to maximise climate, biodiversity and social-equity gains.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;"><strong>Enhance EDI</strong><br>Further improvements should be made to our EDI measure to include local access to greenspace and health-supporting ecosystem services. This will better represent greenspaces many roles.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8;"><strong>Combine multiple datasets for better decisions</strong><br>Tackling social and environmental deprivation takes more than just one measure. Combining social datasets like SIMD with environmental ones will lead to
                                    a long-term way in guiding greenspace funding decisions.</li>
                            </ul>
                        </div>
                        <div id="conclusion-content-3" style="display: none;">
                            <h4 style="font-size: 20px; color: #2d3436; margin-bottom: 20px; font-weight: 600;">Limitations & Challenges</h4>
                            <p style="font-size: 15px; color: #2d3436; margin-bottom: 15px;">Our study faced a few challenges including:</p>
                            <ul style="list-style: disc; padding-left: 20px; margin: 0;">
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;"><strong>Time</strong><br>The lack of time meant less fieldwork measurements, with more data, our results would be more accurate.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8; margin-bottom: 15px;"><strong>Identifying tree species</strong><br>Due to the time of year fieldwork took place (Autumn) it was hard to identify tree species which affects biomass calculations as each different species has a different biomass
                                    equation.</li>
                                <li style="font-size: 15px; color: #2d3436; line-height: 1.8;"><strong>No calibrated biomass map for Edinburgh</strong><br>This meant LiDAR had to be used, which is time consuming and difficult to work with. If there was a calibrated biomass map of Edinburgh, the method used for this
                                    study would be easier and quicker to complete.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Right: Map Image (right half of image14) -->
                    <div style="overflow: hidden; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                        <img src="/dev/group1project/static/report_images/image14.png" alt="Edinburgh Map" style="width: 100%; height: auto; display: block; cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                </div>
            </div>
        </section>

        <script>
            function showConclusionTab(tabNum) {
                // Hide all content
                for (var i = 1; i <= 3; i++) {
                    document.getElementById('conclusion-content-' + i).style.display = 'none';
                    var tab = document.getElementById('conclusion-tab-' + i);
                    tab.style.color = '#636e72';
                    tab.style.fontWeight = '400';
                    tab.querySelector('i').style.color = '#636e72';
                }
                // Show selected content
                document.getElementById('conclusion-content-' + tabNum).style.display = 'block';
                var activeTab = document.getElementById('conclusion-tab-' + tabNum);
                activeTab.style.color = '#2d6a4f';
                activeTab.style.fontWeight = '600';
                activeTab.querySelector('i').style.color = '#2d6a4f';
            }
        </script>

        <!-- Sources -->
        <section id="report-sources" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Data <span>Sources</span></h2>
                <div style="max-width: 900px; margin: 0 auto;">
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                        <h4 style="color: #2d3436; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-database" style="color: var(--neon-blue); margin-right: 10px;"></i>Remote Sensing Data</h4>
                        <ul style="color: #636e72; line-height: 1.8;">
                            <li><strong>LiDAR Data:</strong> Scottish Remote Sensing Portal - 0.5m resolution Canopy Height Model</li>
                            <li><strong>Sentinel-2:</strong> ESA Copernicus - NDVI vegetation indices</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                        <h4 style="color: #2d3436; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-map" style="color: var(--neon-green); margin-right: 10px;"></i>Spatial Data</h4>
                        <ul style="color: #636e72; line-height: 1.8;">
                            <li><strong>SIMD 2020:</strong> Scottish Government - Scottish Index of Multiple Deprivation</li>
                            <li><strong>Graveyard Boundaries:</strong> City of Edinburgh Council</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                        <h4 style="color: #2d3436; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-tree" style="color: #10b981; margin-right: 10px;"></i>Field Data</h4>
                        <ul style="color: #636e72; line-height: 1.8;">
                            <li><strong>Ground Truth:</strong> Field surveys conducted 5-8 November 2024</li>
                            <li><strong>Allometric Equations:</strong> UK Forestry Commission biomass models</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 30px;">
                        <h4 style="color: #2d3436; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-book" style="color: #8b5cf6; margin-right: 10px;"></i>References</h4>
                        <ul style="color: #636e72; line-height: 1.8; font-size: 13px; list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto;">
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Anselin, L., 1995. Local indicators of spatial association - LISA. <em>Geographical Analysis</em>, 27(2): 93-115.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Brede, B., Lau, A., Bartholomeus, H.M. and Kooistra, L., 2017. Comparing RIEGL RiCOPTER UAV LiDAR derived canopy height and DBH with terrestrial LiDAR. <em>Sensors</em>, 17(10): 2371.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Broadmeadow, M. and Matthews, R., 2003. Forests, carbon and climate change: the UK contribution.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Calders, K., Armston, J., Newnham, G., Herold, M. and Goodwin, N., 2014. Implications of sensor configuration and topography on vertical plant profiles derived from terrestrial LiDAR. <em>Agricultural and Forest Meteorology</em>,
                                194: 104-117.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Calders, K., Newnham, G., Burt, A., Murphy, S., Raumonen, P., Herold, M., Culvenor, D., Avitabile, V., Disney, M., Armston, J. and Kaasalainen, M., 2015. Nondestructive estimates of above-ground biomass using terrestrial laser
                                scanning. <em>Methods in Ecology and Evolution</em>, 6(2): 198-208.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Calders, K., Adams, J., Armston, J., et al., 2020. Terrestrial laser scanning in forest ecology: Expanding the horizon. <em>Remote Sensing of Environment</em>, 251: 112102.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Chen, G., Singh, K.K., Lopez, J. and Zhou, Y., 2020. Tree canopy cover and carbon density are different proxy indicators for assessing the relationship between forest structure and urban socio-ecological conditions. <em>Ecological Indicators</em>,
                                113: 106279.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">City of Edinburgh Council (CEC), 2021. 2030 Climate Strategy: Delivering a net zero, climate ready Edinburgh.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">City of Edinburgh Council (CEC), 2023. Culture and Communities Committee: Edinburgh Cemetery Tour Registration Scheme - Update.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">City of Edinburgh Council (CEC), 2024. City Plan 2030: Written Statement.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">City of Edinburgh Council (CEC) Forestry Service, 2023. Trees in the City.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">City of Edinburgh Council (CEC), 2014. Trees in the City: Trees and Woodlands Action Plan.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Davies, Z., Edmondson, J., Heinemeyer, A., Leake, J. and Gaston, K., 2011. Mapping an urban ecosystem service: quantifying above-ground carbon storage at a city-wide scale. <em>Journal of Applied Ecology</em>, 48(5): 1125-1134.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Disney, M., Burt, A., Calders, K., Schaaf, C. and Stovall, A., 2019. Innovations in ground and airborne technologies as reference and for training and validation: terrestrial laser scanning (TLS). <em>Surveys in Geophysics</em>,
                                40(4): 937-958.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Doick, K., Handley, P., Ashwood, F., et al., 2017. Valuing Edinburgh's Urban Trees: An update to the 2011 i-Tree Eco survey. Forest Research: Farnham.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Forrester, D., Tachauer, I., Annighoefer, P., et al., 2017. Generalized biomass and leaf area allometric equations for European tree species. <em>Forest Ecology and Management</em>, 396: 160-175.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Ganz, S., Kaeber, Y. and Adler, P., 2019. Measuring Tree Height with Remote Sensing - A Comparison of Photogrammetric and LiDAR Data with Different Field Measurements. <em>Forests</em>, 10(8): 694.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Hunka, N., May, P., Babcock, C., et al., 2025. A geostatistical approach to enhancing national forest biomass assessments with Earth Observation. <em>Remote Sensing of Environment</em>, 318: 114557.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">IPCC, 2003. IPCC Good Practice Guidance for Land Use, Land-Use Change and Forestry (GPG-LULUCF).</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Junttila, V., Finley, A.O., Bradford, J.B. and Kauranne, T., 2013. Strategies for minimizing sample size for use in airborne LiDAR-based forest inventory. <em>Forest Ecology and Management</em>, 292: 75-85.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Lloyd, C., 2010. Spatial data analysis: an introduction for GIS users. Oxford University Press: Oxford.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Mildrexler, D.J., Berner, L.T., Law, B.E., Birdsey, R.A. and Moomaw, W.R., 2020. Large Trees Dominate Carbon Storage in Forests East of the Cascade Crest. <em>Frontiers in Forests and Global Change</em>, 3.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Muukkonen, P., 2007. Generalized allometric volume and biomass equations for some tree species in Europe. <em>European Journal of Forest Research</em>, 126: 157-166.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">NBN Atlas Scotland, 2018. Search for records | NBN Atlas Scotland.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Pearce, J., Richardson, E., Mitchell, R. and Shortt, N., 2010. Environmental justice and health: the implications of the socio-spatial distribution of multiple environmental deprivation. <em>Transactions of the Institute of British Geographers</em>,
                                35(4): 522-539.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Pearce, J., Richardson, E., Mitchell, R. and Shortt, N., 2011. Environmental justice and health: A study of multiple environmental deprivation and geographical inequalities in health in New Zealand. <em>Social Science and Medicine</em>,
                                73(3): 410-420.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Takagi, K., Yone, Y., Takahashi, H., et al., 2015. Forest biomass and volume estimation using airborne LiDAR in a cool-temperate forest of northern Hokkaido, Japan. <em>Ecological Informatics</em>, 26: 54-60.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Tobler, W.R., 1970. A computer movie simulating urban growth in the Detroit region. <em>Economic Geography</em>, 46(1): 234-240.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Tucker, C., 1979. Red and photographic infrared linear combination for monitoring green vegetation. <em>Remote Sensing of Environment</em>, 8: 127-150.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">UK Civil Aviation Authority (CAA), 2024. The Drone and Model Aircraft Code.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">UNESCO, 2011. Old and New Towns of Edinburgh.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Wilkes, P., Disney, M., Vicari, M., Calders, K. and Burt, A., 2018. Estimating urban above ground biomass with multi-scale LiDAR. <em>Carbon Balance and Management</em>, 13: 10.</li>
                            <li style="margin-bottom: 10px; text-indent: -20px; padding-left: 20px;">Zhang, J., de Gier, A., Xing, Y. and Sohn, G., 2011. Full waveform-based analysis for forest type information derivation from large footprint spaceborne lidar data. <em>Photogrammetric Engineering and Remote Sensing</em>, 77(3):
                                281-290.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <!-- Team -->
        <section id="report-team" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Team</span></h2>
                <div class="report-team-grid">
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Alex Shaw.png" alt="Alex Shaw">
                        <h4>Alex Shaw</h4>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Charlotte Thomson" alt="Charlotte Thomson">
                        <h4>Charlotte Thomson</h4>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Lama Alqahtani" alt="Lama Alqahtani">
                        <h4>Lama Alqahtani</h4>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Ollie Cavil" alt="Ollie Cavill">
                        <h4>Ollie Cavill</h4>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Wu Xinxin" alt="Wu Xinxin">
                        <h4>Wu Xinxin</h4>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Xiao Lang" alt="Xiao Lang">
                        <h4>Xiao Lang</h4>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="report-footer">
            <div class="report-footer-inner">
                <!-- Content Right -->
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px; width: 100%;">
                    <div style="font-size: 12px; opacity: 0.7; text-align: right;">
                        &copy; 2025 University of Edinburgh. All rights reserved.<br>
                        <span style="font-size: 10px;">Data: Scottish Government SIMD 2020, Scottish Remote Sensing Portal LiDAR, ESA Sentinel-2</span>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <a href="https://github.com/langxiao323-lab/deploy-web" target="_blank" style="color: #fff; font-size: 20px; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="View Project on GitHub"><i class="fab fa-github"></i></a>
                        <a href="mailto:s2835812@ed.ac.uk" style="color: #fff; font-size: 20px; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="Contact Us"><i class="fas fa-envelope"></i></a>
                        <span style="font-size: 13px; opacity: 0.8; margin-left: 10px;">Developed by <strong>Group 1</strong> | MSc GIS 2025</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: pointer;" onclick="closeImageModal()">
        <img id="modalImage" src="" alt="Enlarged Image" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
        <span style="position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer;">&times;</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // Page switching function
        function switchPage(page) {
            if (page === 'map') {
                document.getElementById('map-page').classList.add('active');
                document.getElementById('report-page').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('btn-report').style.background = 'rgba(139, 92, 246, 0.1)';
                document.getElementById('btn-report').style.borderColor = 'rgba(139, 92, 246, 0.5)';
                document.getElementById('btn-report').style.color = 'rgba(139, 92, 246, 0.7)';
                if (document.getElementById('btn-map-from-report')) {
                    document.getElementById('btn-map-from-report').classList.add('active');
                    document.getElementById('btn-report-from-report').classList.remove('active');
                }
                window.scrollTo(0, 0);
                // Invalidate map size after showing
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            } else if (page === 'report') {
                document.getElementById('map-page').classList.remove('active');
                document.getElementById('report-page').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('btn-report').style.background = 'rgba(14, 165, 233, 0.2)';
                document.getElementById('btn-report').style.borderColor = 'var(--neon-blue)';
                document.getElementById('btn-report').style.color = 'var(--neon-blue)';
                if (document.getElementById('btn-map-from-report')) {
                    document.getElementById('btn-map-from-report').classList.remove('active');
                    document.getElementById('btn-report-from-report').classList.add('active');
                }
                window.scrollTo(0, 0);
            }
        }

        // Hide sidebar on page load (default to report page)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sidebar').classList.add('hidden');
        });

        // Image modal functions
        function openImageModal(src) {
            var modal = document.getElementById('imageModal');
            var modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function submitFeedback(event) {
            event.preventDefault();
            var form = document.getElementById('feedbackForm');
            var message = document.getElementById('feedbackMessage');
            message.style.display = 'block';
            message.style.color = '#10b981';
            message.textContent = 'Thank you for your feedback!';
            form.reset();
            setTimeout(function() {
                message.style.display = 'none';
            }, 3000);
        }

        // Back to Top Button visibility
        window.addEventListener('scroll', function() {
            var backToTop = document.getElementById('backToTop');
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });

        // Handle window resize for map
        window.addEventListener('resize', function() {
            if (typeof map !== 'undefined' && document.getElementById('map-page').classList.contains('active')) {
                map.invalidateSize();
            }
        });

        var map = L.map('map', {
            zoomControl: false
        }).setView([55.9533, -3.1883], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        var geojsonLayer;
        var rawData;
        var currentMode = 'carbon';
        var selectedFeature = null;
        var routingControl = null;
        var simdLayer = null;
        var showSIMDBackground = false;

        // SIMD background layer style
        function getSIMDStyle(feature) {
            var rank = feature.properties.SIMD_Rank;
            var decile = feature.properties.SIMD_Decile;
            var color = '#94a3b8';

            // Color by decile (1=most deprived, 10=least deprived)
            if (decile <= 2) color = '#ea580c'; // Dark orange - most deprived
            else if (decile <= 4) color = '#f97316'; // Orange
            else if (decile <= 6) color = '#fbbf24'; // Yellow
            else if (decile <= 8) color = '#fde047'; // Light yellow
            else color = '#fef9c3'; // Pale yellow - least deprived

            return {
                fillColor: color,
                weight: 0.5,
                opacity: 0.5,
                color: '#333',
                fillOpacity: 0.4
            };
        }

        // Toggle SIMD background layer
        function toggleSIMDBackground() {
            showSIMDBackground = !showSIMDBackground;
            if (simdLayer) {
                if (showSIMDBackground) {
                    simdLayer.addTo(map);
                    simdLayer.bringToBack();
                } else {
                    map.removeLayer(simdLayer);
                }
            }
            // Update button style
            var btn = document.getElementById('simd-bg-btn');
            if (btn) {
                btn.style.background = showSIMDBackground ? 'rgba(239, 68, 68, 0.5)' : 'rgba(239, 68, 68, 0.2)';
            }
            // Toggle SIMD legend visibility
            var simdLegend = document.getElementById('simd-legend');
            if (simdLegend) {
                simdLegend.style.display = showSIMDBackground ? 'block' : 'none';
            }
        }

        function getStyle(feature) {
            var p = feature.properties;
            var color = '#94a3b8';
            var opacity = 0.5;

            if (currentMode === 'carbon') {
                // Carbon per hectare: high contrast color scheme
                var c = p.CarbonPerHectare || 0;
                if (c > 120) color = '#1e3a5f'; // Dark blue
                else if (c > 80) color = '#0891b2'; // Cyan
                else if (c > 40) color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow
            } else if (currentMode === 'agb') {
                // AGB Total: high contrast
                var agb = p.AGBTotal || 0;
                if (agb > 100) color = '#1e3a5f'; // Dark blue
                else if (agb > 50) color = '#0891b2'; // Cyan
                else if (agb > 20) color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow
            } else if (currentMode === 'edi') {
                // EDI: 0-1 range (0=most deprived, 1=least deprived)
                var edi = p.EDI || 0;
                if (edi >= 0.6) color = '#1e3a5f'; // Dark blue (least deprived)
                else if (edi >= 0.4) color = '#0891b2'; // Cyan
                else if (edi >= 0.25) color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow (most deprived)
            } else if (currentMode === 'ndvi') {
                // NDVI: 0-1 range, high contrast
                var ndvi = p.NDVI || 0;
                if (ndvi >= 0.4) color = '#1e3a5f'; // Dark blue
                else if (ndvi >= 0.3) color = '#0891b2'; // Cyan
                else if (ndvi >= 0.2) color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow
            } else if (currentMode === 'canopy') {
                // Canopy Percentage: high contrast
                var canopy = p.Canopy || 0;
                if (canopy >= 70) color = '#1e3a5f'; // Dark blue
                else if (canopy >= 50) color = '#0891b2'; // Cyan
                else if (canopy >= 30) color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow
            } else if (currentMode === 'simd') {
                // SIMD: 5-level classification matching background layer
                if (p.SIMD <= 2) color = '#ea580c'; // Dark orange - most deprived
                else if (p.SIMD <= 4) color = '#f97316'; // Orange
                else if (p.SIMD <= 6) color = '#fbbf24'; // Yellow
                else if (p.SIMD <= 8) color = '#fde047'; // Light yellow
                else color = '#fef9c3'; // Pale yellow - least deprived
            } else if (currentMode === 'strata') {
                // Strata: high contrast
                if (p.Strata === 'High') color = '#1e3a5f'; // Dark blue
                else if (p.Strata === 'Medium') color = '#34d399'; // Bright green
                else color = '#fbbf24'; // Yellow
            }

            return {
                fillColor: color,
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: opacity
            };
        }

        function updateLegend() {
            // Hide extra legend items by default
            document.getElementById('legend-item-2').style.display = 'none';
            document.getElementById('legend-item-4').style.display = 'none';

            if (currentMode === 'carbon') {
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-2').style.background = '#0891b2';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = '>120 t/ha';
                document.getElementById('legend-map-2-text').textContent = '80-120 t/ha';
                document.getElementById('legend-map-3-text').textContent = '40-80 t/ha';
                document.getElementById('legend-map-5-text').textContent = '<40 t/ha';
            } else if (currentMode === 'agb') {
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-2').style.background = '#0891b2';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = '>100 t';
                document.getElementById('legend-map-2-text').textContent = '50-100 t';
                document.getElementById('legend-map-3-text').textContent = '20-50 t';
                document.getElementById('legend-map-5-text').textContent = '<20 t';
            } else if (currentMode === 'edi') {
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-2').style.background = '#0891b2';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = 'Least Deprived (>0.6)';
                document.getElementById('legend-map-2-text').textContent = 'Low Deprivation (0.4-0.6)';
                document.getElementById('legend-map-3-text').textContent = 'Med Deprivation (0.25-0.4)';
                document.getElementById('legend-map-5-text').textContent = 'Most Deprived (<0.25)';
            } else if (currentMode === 'ndvi') {
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-2').style.background = '#0891b2';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = 'High (>0.4)';
                document.getElementById('legend-map-2-text').textContent = 'Med-High (0.3-0.4)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (0.2-0.3)';
                document.getElementById('legend-map-5-text').textContent = 'Low (<0.2)';
            } else if (currentMode === 'canopy') {
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-2').style.background = '#0891b2';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = 'Dense (>70%)';
                document.getElementById('legend-map-2-text').textContent = 'Med-Dense (50-70%)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (30-50%)';
                document.getElementById('legend-map-5-text').textContent = 'Sparse (<30%)';
            } else if (currentMode === 'simd') {
                // SIMD mode: show all 5 legend items
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-item-4').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#fef9c3';
                document.getElementById('legend-map-2').style.background = '#fde047';
                document.getElementById('legend-map-3').style.background = '#fbbf24';
                document.getElementById('legend-map-4').style.background = '#f97316';
                document.getElementById('legend-map-5').style.background = '#ea580c';
                document.getElementById('legend-map-1-text').textContent = 'Least Deprived (9-10)';
                document.getElementById('legend-map-2-text').textContent = 'Low (7-8)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (5-6)';
                document.getElementById('legend-map-4-text').textContent = 'High (3-4)';
                document.getElementById('legend-map-5-text').textContent = 'Most Deprived (1-2)';
            } else if (currentMode === 'strata') {
                document.getElementById('legend-map-1').style.background = '#1e3a5f';
                document.getElementById('legend-map-3').style.background = '#34d399';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = 'High';
                document.getElementById('legend-map-3-text').textContent = 'Medium';
                document.getElementById('legend-map-5-text').textContent = 'Low';
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateLegend();
            geojsonLayer.setStyle(getStyle);
            renderList();
        }

        function getLayerByFeature(f) {
            var found = null;
            geojsonLayer.eachLayer(l => {
                if (l.feature === f) found = l;
            });
            return found;
        }

        function updateSim(percent) {
            document.getElementById('sim-val').innerText = `+${percent}%`;
            if (selectedFeature) {
                var currentC = parseFloat(selectedFeature.properties.CarbonPerHectare || 0);
                var projected = currentC * (1 + percent / 100);
                document.getElementById('sim-result').innerText = `${projected.toFixed(1)} t/ha`;
            }
        }

        function renderList() {
            var container = document.getElementById('list');
            container.innerHTML = '';

            // Sort based on current mode
            var sorted = [...rawData.features].sort((a, b) => {
                if (currentMode === 'carbon') return b.properties.CarbonPerHectare - a.properties.CarbonPerHectare;
                if (currentMode === 'agb') return b.properties.AGBTotal - a.properties.AGBTotal;
                if (currentMode === 'edi') return b.properties.EDI - a.properties.EDI;
                if (currentMode === 'ndvi') return b.properties.NDVI - a.properties.NDVI;
                if (currentMode === 'canopy') return b.properties.Canopy - a.properties.Canopy;
                if (currentMode === 'simd') return a.properties.SIMD - b.properties.SIMD;
                return 0;
            });

            sorted.forEach(f => {
                var p = f.properties;
                if (!p.has_data) return;
                var el = document.createElement('div');
                el.className = 'list-item';

                // Display value based on current mode
                var valueDisplay = '';
                if (currentMode === 'carbon') valueDisplay = `${p.CarbonPerHectare ? p.CarbonPerHectare.toFixed(1) : '0'} t/ha`;
                else if (currentMode === 'agb') valueDisplay = `${p.AGBTotal ? p.AGBTotal.toFixed(1) : '0'} t`;
                else if (currentMode === 'edi') valueDisplay = `EDI: ${p.EDI || '0'}`;
                else if (currentMode === 'ndvi') valueDisplay = `NDVI: ${p.NDVI ? p.NDVI.toFixed(3) : '0'}`;
                else if (currentMode === 'canopy') valueDisplay = `${p.Canopy ? p.Canopy.toFixed(1) : '0'}%`;
                else if (currentMode === 'simd') valueDisplay = `SIMD: ${p.SIMD || 'N/A'}`;
                else if (currentMode === 'strata') valueDisplay = p.Strata || 'N/A';

                // Generate tags with appropriate classes
                var tagsHtml = (p.ReportTags || []).map(t => {
                    var tagClass = 'tag';
                    if (t.includes('Priority')) tagClass += ' priority';
                    if (t.includes('Biodiversity') || t.includes('Species')) tagClass += ' biodiversity';
                    if (t.includes('Heritage') || t.includes('Monument') || t.includes('Tourist')) tagClass += ' heritage';
                    if (t.includes('Highest')) tagClass += ' highest';
                    return `<span class="${tagClass}">${t}</span>`;
                }).join(' ');

                // Add special class for priority/highest EDI sites
                var specialClass = '';
                if ((p.ReportTags || []).some(t => t.includes('Priority'))) specialClass = 'priority-site';
                if ((p.ReportTags || []).some(t => t.includes('Highest'))) specialClass = 'highest-edi';

                el.className = `list-item ${specialClass}`;

                // Get centroid coordinates for distance calculation
                var coords = f.geometry.coordinates;
                var centLat = 0,
                    centLon = 0;
                if (f.geometry.type === 'Polygon') {
                    coords[0].forEach(c => {
                        centLon += c[0];
                        centLat += c[1];
                    });
                    centLon /= coords[0].length;
                    centLat /= coords[0].length;
                } else if (f.geometry.type === 'MultiPolygon') {
                    var total = 0;
                    coords.forEach(poly => {
                        poly[0].forEach(c => {
                            centLon += c[0];
                            centLat += c[1];
                            total++;
                        });
                    });
                    centLon /= total;
                    centLat /= total;
                }
                el.setAttribute('data-lat', centLat);
                el.setAttribute('data-lon', centLon);

                el.innerHTML = `
                <div class="item-header">
                    <span>${p.name}</span>
                    <span class="list-item-carbon" style="color:${getStyle(f).fillColor}">${valueDisplay}</span>
                </div>
                <div class="item-sub"><span>SIMD: ${p.SIMD || 'N/A'}</span>${tagsHtml}</div>
            `;
                el.onclick = () => {
                    var layer = getLayerByFeature(f);
                    map.flyToBounds(layer.getBounds(), {
                        padding: [150, 150],
                        maxZoom: 17
                    });
                    layer.fire('click');
                };
                container.appendChild(el);
            });
        }

        // Flickr API key (free tier)
        var FLICKR_API_KEY = '25506987f67f81e9a5ae6aa198fae3cf';

        function fetchWikiImage(name, imgElementId) {
            var cleanName = name.split('(')[0].trim();
            var searchTerm = cleanName + " Edinburgh cemetery";
            var searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${searchTerm}&format=json&origin=*`;
            var imgElement = document.getElementById(imgElementId);
            var imgContainer = imgElement ? imgElement.parentElement : null;

            // Try Wikipedia first
            fetch(searchUrl)
                .then(r => r.json())
                .then(data => {
                    if (data.query.search.length > 0) {
                        var pageTitle = data.query.search[0].title;
                        var imgUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${pageTitle}&prop=pageimages&format=json&pithumbsize=400&origin=*`;
                        return fetch(imgUrl);
                    } else {
                        throw new Error("No wiki page");
                    }
                })
                .then(r => r.json())
                .then(data => {
                    var pages = data.query.pages;
                    var pageId = Object.keys(pages)[0];
                    if (pages[pageId].thumbnail) {
                        imgElement.src = pages[pageId].thumbnail.source;
                    } else {
                        // No Wikipedia image, try Flickr
                        fetchFlickrImage(cleanName, imgElement, imgContainer);
                    }
                })
                .catch(e => {
                    // Wikipedia failed, try Flickr
                    fetchFlickrImage(cleanName, imgElement, imgContainer);
                });
        }

        function fetchFlickrImage(searchTerm, imgElement, imgContainer) {
            var flickrUrl = `https://www.flickr.com/services/rest/?method=flickr.photos.search&api_key=${FLICKR_API_KEY}&text=${encodeURIComponent(searchTerm + ' Edinburgh')}&sort=relevance&per_page=1&format=json&nojsoncallback=1`;

            fetch(flickrUrl)
                .then(r => r.json())
                .then(data => {
                    if (data.photos && data.photos.photo && data.photos.photo.length > 0) {
                        var photo = data.photos.photo[0];
                        // Construct Flickr image URL
                        var photoUrl = `https://live.staticflickr.com/${photo.server}/${photo.id}_${photo.secret}_w.jpg`;
                        imgElement.src = photoUrl;
                    } else {
                        // No Flickr image, hide container
                        if (imgContainer) imgContainer.style.display = 'none';
                    }
                })
                .catch(e => {
                    // Flickr failed, hide container
                    if (imgContainer) imgContainer.style.display = 'none';
                });
        }

        // Advanced Filters
        function applyFilters() {
            var carbonMin = parseFloat(document.getElementById('carbon-min').value) || 0;
            var carbonMax = parseFloat(document.getElementById('carbon-max').value) || 9999;

            var filteredCount = 0;

            geojsonLayer.eachLayer(layer => {
                var p = layer.feature.properties;
                var carbon = p.CarbonPerHectare || 0;

                if (carbon >= carbonMin && carbon <= carbonMax) {
                    layer.setStyle({
                        opacity: 1,
                        fillOpacity: 0.5
                    });
                    filteredCount++;
                } else {
                    layer.setStyle({
                        opacity: 0.2,
                        fillOpacity: 0.1
                    });
                }
            });

            alert(`Filters applied! Showing ${filteredCount} sites matching criteria.`);
            renderList();
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }


        // Export data
        function exportData() {
            if (!rawData) {
                alert('No data available to export');
                return;
            }

            const dataStr = JSON.stringify(rawData, null, 2);
            const dataBlob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'edinburgh_graveyards_data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Data exported successfully!');
        }

        // Haversine distance calculation (km)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // UK postcode regex
        function isUKPostcode(str) {
            var regex = /^[A-Z]{1,2}[0-9][0-9A-Z]?\s?[0-9][A-Z]{2}$/i;
            return regex.test(str.trim());
        }

        // Search/Filter list
        function filterList() {
            var searchTerm = document.getElementById('search-input').value.trim();
            var items = document.querySelectorAll('.list-item');

            // Check if it's a UK postcode
            if (isUKPostcode(searchTerm)) {
                searchByPostcode(searchTerm);
                return;
            }

            // Normal text search
            var lowerSearch = searchTerm.toLowerCase();
            items.forEach(item => {
                var text = item.textContent.toLowerCase();
                if (text.includes(lowerSearch)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Search by postcode - find graveyards within 5km
        function searchByPostcode(postcode) {
            var items = document.querySelectorAll('.list-item');
            var searchInput = document.getElementById('search-input');
            searchInput.style.background = 'rgba(14, 165, 233, 0.3)';

            fetch('https://api.postcodes.io/postcodes/' + encodeURIComponent(postcode.replace(/\s/g, '')))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 200 && data.result) {
                        var lat = data.result.latitude;
                        var lon = data.result.longitude;
                        var count = 0;

                        items.forEach(item => {
                            var itemLat = parseFloat(item.getAttribute('data-lat'));
                            var itemLon = parseFloat(item.getAttribute('data-lon'));
                            if (itemLat && itemLon) {
                                var dist = haversineDistance(lat, lon, itemLat, itemLon);
                                if (dist <= 5) {
                                    item.style.display = 'block';
                                    item.querySelector('.list-item-carbon').innerHTML = dist.toFixed(1) + ' km away';
                                    count++;
                                } else {
                                    item.style.display = 'none';
                                }
                            }
                        });

                        searchInput.style.background = 'rgba(16, 185, 129, 0.3)';
                        searchInput.placeholder = count + ' graveyards within 5km';

                        // Center map on postcode location
                        if (map) {
                            map.setView([lat, lon], 13);
                            L.marker([lat, lon], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: '<div style="background:#ef4444;color:#fff;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;"><i class="fas fa-map-marker-alt"></i> ' + postcode.toUpperCase() + '</div>',
                                    iconSize: [100, 30],
                                    iconAnchor: [50, 15]
                                })
                            }).addTo(map);
                        }
                    } else {
                        searchInput.style.background = 'rgba(239, 68, 68, 0.3)';
                        searchInput.placeholder = 'Invalid postcode';
                    }
                    setTimeout(() => {
                        searchInput.style.background = '';
                        searchInput.placeholder = 'Name or Postcode (e.g. EH1 1QS)';
                    }, 3000);
                })
                .catch(err => {
                    console.error('Postcode lookup error:', err);
                    searchInput.style.background = 'rgba(239, 68, 68, 0.3)';
                    setTimeout(() => {
                        searchInput.style.background = '';
                    }, 2000);
                });
        }

        // Load data from API - use relative path to adapt to deployment path
        var apiPath = window.location.pathname.replace(/\/$/, '') + '/api/graveyards';
        if (apiPath.startsWith('//')) apiPath = apiPath.substring(1);

        fetch(apiPath)
            .then(response => response.json())
            .then(data => {
                rawData = data;

                // Calculate statistics
                var totalEDI = 0;
                var count = 0;
                data.features.forEach(f => {
                    if (f.properties.has_data) {
                        totalEDI += f.properties.EDI || 0;
                        count++;
                    }
                });

                // Use total carbon directly from database
                document.getElementById('stat-carbon').textContent = data.totalCarbonFromDB || '0';
                document.getElementById('stat-avg-edi').textContent = (totalEDI / count).toFixed(1);

                // Add GeoJSON layer
                geojsonLayer = L.geoJSON(data, {
                    style: getStyle,
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function() {
                            selectedFeature = feature;
                            var p = feature.properties;
                            var imgId = 'popup-img-' + p.id;

                            var coords = layer.getBounds().getCenter();
                            var googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}`;

                            var popupContent = `
                            <div class="popup-info" style="padding-top: 15px;">
                                <h2 class="popup-header">${p.name}</h2>
                                <div class="popup-stats">
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Area</div>
                                        <div class="popup-stat-value" style="color: var(--neon-yellow);">${p.Area ? (p.Area / 10000).toFixed(2) : 'N/A'} ha</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Carbon/Ha</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.CarbonPerHectare ? p.CarbonPerHectare.toFixed(1) : 'N/A'} t/ha</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Total Carbon</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.AGBTotal ? p.AGBTotal.toFixed(1) : 'N/A'} t</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Canopy %</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.Canopy ? p.Canopy.toFixed(1) : 'N/A'}%</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">EDI Score</div>
                                        <div class="popup-stat-value" style="color: var(--neon-blue);">${p.EDI || 'N/A'}</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">NDVI</div>
                                        <div class="popup-stat-value" style="color: var(--neon-blue);">${p.NDVI ? p.NDVI.toFixed(3) : 'N/A'}</div>
                                    </div>
                            </div>
                        `;

                            layer.bindPopup(popupContent, {
                                maxWidth: 320
                            }).openPopup();
                        });
                    }
                }).addTo(map);

                // Add number labels to each graveyard
                var labelIndex = 1;
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.feature.properties.has_data) {
                        var center = layer.getBounds().getCenter();
                        var numberIcon = L.divIcon({
                            className: 'graveyard-number-label',
                            html: '<div class="number-marker">' + labelIndex + '</div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        var marker = L.marker(center, {
                            icon: numberIcon,
                            interactive: true
                        });
                        marker.on('click', function() {
                            map.flyToBounds(layer.getBounds(), {
                                padding: [150, 150],
                                maxZoom: 17
                            });
                            layer.fire('click');
                        });
                        marker.addTo(map);
                        labelIndex++;
                    }
                });

                // Render list
                renderList();

                // Load SIMD background layer
                var simdApiPath = window.location.pathname.replace(/\/$/, '') + '/api/simd';
                if (simdApiPath.startsWith('//')) simdApiPath = simdApiPath.substring(1);

                fetch(simdApiPath)
                    .then(response => response.json())
                    .then(simdData => {
                        simdLayer = L.geoJSON(simdData, {
                            style: getSIMDStyle,
                            onEachFeature: function(feature, layer) {
                                layer.bindTooltip(
                                    `<b>${feature.properties.Name}</b><br>SIMD Rank: ${feature.properties.SIMD_Rank}<br>Decile: ${feature.properties.SIMD_Decile}`, {
                                        sticky: true
                                    }
                                );
                            }
                        });
                        console.log('SIMD layer loaded with ' + simdData.features.length + ' areas');
                    })
                    .catch(err => console.error('Error loading SIMD data:', err));

                // Hide loading
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '<div class="spinner"></div><div class="loading-text">Error loading data. Please refresh.</div>';
            });

        // Add zoom controls
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
    </script>
</body>

</html>