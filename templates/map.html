<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Edinburgh Carbon Intelligence - Research on carbon storage potential in Edinburgh's graveyards. Interactive map and detailed analysis of environmental and social deprivation.">
    <meta name="keywords" content="Edinburgh, carbon storage, graveyards, environmental research, GeoSciences, University of Edinburgh">
    <meta name="author" content="University of Edinburgh - School of GeoSciences">
    <meta property="og:title" content="Edinburgh Carbon Intelligence">
    <meta property="og:description" content="What graveyards tell us about carbon and communities">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/png" href="/dev/group1project/static/report_images/University_of_Edinburgh_Coat_of_Arm.png">
    <title>Edinburgh Carbon Intelligence - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
         :root {
            --bg-dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.95);
            --neon-blue: #0ea5e9;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-purple: #8b5cf6;
            --neon-yellow: #f59e0b;
            --text: #f1f5f9;
            --border: rgba(148, 163, 184, 0.2);
        }
        
        * {
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        /* Back to Top Button */
        
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #e94560;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background: #d63850;
            transform: translateY(-3px);
        }
        
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow-x: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }
        /* Loading Spinner */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.98);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            font-family: 'Rajdhani';
            font-size: 18px;
            color: var(--neon-blue);
        }
        
        .sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            bottom: 20px;
            width: 400px;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(-420px);
        }
        
        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .sidebar-toggle:hover {
            background: rgba(14, 165, 233, 0.2);
        }
        
        .header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            font-family: 'Rajdhani';
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-transform: uppercase;
            background: linear-gradient(135deg, #fff 0%, var(--neon-blue) 50%, var(--neon-purple) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0%,
            100% {
                filter: hue-rotate(0deg);
            }
            50% {
                filter: hue-rotate(10deg);
            }
        }
        
        .header p {
            margin: 8px 0 0;
            font-size: 13px;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }
        /* Legend */
        
        .legend {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 15px;
            justify-content: space-around;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        /* Stats Panel */
        
        .stats-panel {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-family: 'Rajdhani';
            font-size: 20px;
            font-weight: 700;
            color: var(--neon-blue);
        }
        
        .stat-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            margin-top: 4px;
        }
        /* Search Box */
        
        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            outline: none;
            font-size: 13px;
            transition: 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .search-input::placeholder {
            color: #64748b;
        }
        
        .controls {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .mode-btn {
            padding: 12px 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(14, 165, 233, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .mode-btn:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .mode-btn.active {
            background: rgba(14, 165, 233, 0.2);
            color: var(--neon-blue);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }
        
        .list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .list-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .list-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        .list-container::-webkit-scrollbar-thumb:hover {
            background: var(--neon-blue);
        }
        
        .list-item {
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .list-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .item-sub {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 8px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .simulator {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border);
        }
        
        .sim-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--neon-green);
            margin-bottom: 10px;
        }
        
        input[type=range] {
            width: 100%;
            accent-color: var(--neon-green);
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.98);
            color: #fff;
            border: 2px solid var(--neon-blue);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            padding: 0;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(14, 165, 233, 0.3);
        }
        
        .leaflet-popup-content {
            margin: 0;
            width: 320px !important;
        }
        
        .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .leaflet-container a.leaflet-popup-close-button {
            color: #fff;
            font-size: 18px;
            top: 5px;
            right: 5px;
        }
        
        .popup-img-container {
            width: 100%;
            height: 140px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }
        
        .popup-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .popup-img:hover {
            transform: scale(1.1);
        }
        
        .popup-info {
            padding: 20px;
        }
        
        .popup-header {
            font-family: 'Rajdhani';
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 15px 0;
        }
        
        .popup-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .popup-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .popup-stat-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
        }
        
        .popup-stat-value {
            font-family: 'Rajdhani';
            font-size: 18px;
            font-weight: 700;
            margin-top: 4px;
        }
        /* Export Button */
        
        .export-btn {
            position: absolute;
            bottom: 160px;
            right: 20px;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .export-btn:hover {
            background: rgba(14, 165, 233, 0.2);
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        
        .tag {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }
        
        .tag.priority {
            border-color: var(--neon-red);
            color: var(--neon-red);
            background: rgba(239, 68, 68, 0.15);
        }
        
        .tag.biodiversity {
            border-color: var(--neon-green);
            color: var(--neon-green);
            background: rgba(16, 185, 129, 0.15);
        }
        
        .tag.heritage {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .tag.highest {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
            background: rgba(14, 165, 233, 0.15);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        /* Legend on map */
        
        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            min-width: 150px;
        }
        
        .map-legend-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            color: var(--neon-blue);
        }
        
        .legend-item-map {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            margin-bottom: 6px;
        }
        
        .legend-color-map {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        /* Graveyard number labels */
        
        .graveyard-number-label {
            background: transparent;
        }
        
        .number-marker {
            width: 24px;
            height: 24px;
            background: rgba(14, 165, 233, 0.9);
            border: 2px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .number-marker:hover {
            transform: scale(1.2);
            background: rgba(139, 92, 246, 0.9);
        }
        /* Priority highlight for list items */
        
        .list-item.priority-site {
            border-left-color: var(--neon-red);
            background: rgba(239, 68, 68, 0.08);
        }
        
        .list-item.highest-edi {
            border-left-color: var(--neon-blue);
            background: rgba(14, 165, 233, 0.08);
        }
        /* Report Page Styles */
        
        #report-page {
            display: block;
        }
        
        #report-page.hidden {
            display: none;
        }
        
        #map-page {
            display: none;
        }
        
        #map-page.active {
            display: block;
        }
        /* Hide sidebar when report page is shown - controlled by JavaScript */
        
        .sidebar.hidden {
            display: none;
        }
        /* Report Navigation */
        
        .report-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(45, 52, 54, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 0 20px;
            transition: box-shadow 0.3s, background 0.3s;
        }
        
        .report-nav.scrolled {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            background: rgba(30, 35, 38, 0.98);
        }
        /* Mobile Responsive */
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                height: 50vh;
                border-radius: 16px 16px 0 0;
            }
            .sidebar.collapsed {
                transform: translateY(calc(50vh - 60px));
            }
            .export-btn {
                bottom: auto;
                top: 20px;
            }
        }
        
        .report-nav-inner {
            max-width: 100%;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .report-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
        }
        
        .report-logo img {
            height: 250px;
        }
        
        .report-logo-text {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
        }
        
        .report-nav-links {
            display: flex;
            gap: 30px;
        }
        
        .report-nav-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .report-nav-links a:hover {
            color: #fff;
        }
        
        .report-nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .report-nav-buttons button {
            padding: 10px 15px;
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.5);
            color: rgba(14, 165, 233, 0.7);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .report-nav-buttons button:hover {
            background: rgba(14, 165, 233, 0.3);
        }
        
        .report-nav-buttons button.active {
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
        }
        /* Report Page Content */
        
        .report-hero {
            min-height: 100vh;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #2d3436;
            padding: 100px 40px;
            margin-top: 70px;
        }
        
        .report-hero-content {
            max-width: 100%;
            width: 100%;
        }
        
        .report-hero h1 {
            font-family: 'EB Garamond', serif;
            font-size: 56px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #2d3436;
        }
        
        .report-hero .subtitle {
            font-size: 22px;
            color: #2d3436;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .report-hero-image {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }
        
        .report-section {
            padding: 100px 40px;
        }
        
        .report-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .report-section-title {
            font-family: 'EB Garamond', serif;
            font-size: 42px;
            color: #2d3436;
            margin-bottom: 50px;
            text-align: center;
        }
        
        .report-section-title span {
            color: #2d3436;
        }
        
        .report-content-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            align-items: center;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .report-content-card.reverse {
            direction: rtl;
        }
        
        .report-content-card.reverse>* {
            direction: ltr;
        }
        
        .report-card-image {
            height: 100%;
            min-height: 350px;
            position: relative;
            overflow: hidden;
        }
        
        .report-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .report-card-image img:hover {
            transform: scale(1.05);
        }
        
        .report-card-content {
            padding: 40px;
        }
        
        .report-card-content h3 {
            font-family: 'EB Garamond', serif;
            font-size: 28px;
            color: #2d3436;
            margin-bottom: 20px;
        }
        
        .report-card-content p {
            font-size: 15px;
            color: #2d3436;
            margin-bottom: 15px;
        }
        
        .report-card-content ul {
            list-style: none;
            padding: 0;
        }
        
        .report-card-content li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-card-content li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 14px;
            width: 8px;
            height: 8px;
            background: #2d3436;
            border-radius: 50%;
        }
        
        .report-key-points {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 40px;
        }
        
        .report-key-point {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .report-key-point i {
            font-size: 36px;
            color: #e94560;
            margin-bottom: 15px;
        }
        
        .report-key-point h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 10px;
            color: #2d3436;
        }
        
        .report-key-point p {
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 40px 0;
        }
        
        .report-stat {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .report-stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .report-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .report-recommendations {
            margin-top: 40px;
        }
        
        .report-rec-item {
            display: flex;
            gap: 20px;
            padding: 25px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .report-rec-number {
            width: 40px;
            height: 40px;
            background: #e94560;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .report-rec-content h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3436;
        }
        
        .report-rec-content p {
            font-size: 14px;
            color: #2d3436;
        }
        
        .report-team-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-top: 40px;
        }
        
        .report-team-member {
            text-align: center;
        }
        
        .report-team-avatar-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 12px;
            border: 3px solid #f8f9fa;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .report-team-member h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #2d3436;
        }
        
        .report-team-member p {
            font-size: 12px;
            color: #2d3436;
        }
        
        .report-footer {
            background: #636e72;
            color: #fff;
            padding: 15px 40px;
        }
        
        .report-footer-inner {
            max-width: 100%;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .report-footer-form h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .report-footer-form input,
        .report-footer-form textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }
        
        .report-footer-form input::placeholder,
        .report-footer-form textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .report-footer-form textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .report-footer-form button {
            padding: 10px 25px;
            background: #e94560;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .report-footer-form button:hover {
            background: #d63850;
        }
        
        .report-footer-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .report-footer-brand img {
            height: 60px;
        }
        
        .report-footer-info h4 {
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .report-footer-info p {
            font-size: 13px;
            opacity: 0.7;
        }
        
        .report-footer-contact p {
            font-size: 14px;
            margin: 5px 0;
        }
        
        .report-footer-contact a {
            color: #e94560;
            text-decoration: none;
        }
        
        @media (max-width: 900px) {
            .report-content-card {
                grid-template-columns: 1fr;
            }
            .report-content-card.reverse {
                direction: ltr;
            }
            .report-key-points {
                grid-template-columns: 1fr;
            }
            .report-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .report-team-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .report-team-member {
                text-align: center;
            }
            .report-team-avatar-img {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                object-fit: cover;
                margin: 0 auto 12px;
                border: 3px solid #f8f9fa;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            .report-team-member h4 {
                font-size: 14px;
                margin-bottom: 3px;
                color: #2d3436;
            }
            .report-hero h1 {
                font-size: 36px;
            }
            .report-hero-content>div {
                flex-direction: column !important;
                padding: 0 20px !important;
            }
            .report-hero-content>div img {
                width: 100% !important;
                max-width: 100% !important;
            }
            .report-footer-inner {
                flex-direction: column;
                padding: 0 20px;
            }
            .report-footer-brand img {
                height: 150px;
            }
            .report-footer-form {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Edinburgh Graveyard Data...</div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>

        <div class="header">
            <h1>Carbon Intelligence</h1>
            <p>Edinburgh Greenspace Analysis System</p>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="switchPage('map')" id="btn-map" style="flex: 1; padding: 10px; background: rgba(14, 165, 233, 0.2); border: 1px solid var(--neon-blue); color: var(--neon-blue); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;"
                    onmouseover="this.style.background='rgba(14, 165, 233, 0.3)'" onmouseout="this.style.background='rgba(14, 165, 233, 0.2)'">
                    <i class="fa-solid fa-map"></i> Interactive Map
                </button>
                <button onclick="switchPage('report')" id="btn-report" style="flex: 1; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.5); color: rgba(139, 92, 246, 0.7); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;"
                    onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                    <i class="fa-solid fa-home"></i> Home
                </button>
            </div>
        </div>

        <!-- View Mode Controls -->
        <div class="controls" style="grid-template-columns: repeat(2, 1fr);">
            <button class="mode-btn active" onclick="setMode('carbon')" title="Carbon storage per hectare (tonnes/ha) - Shows carbon density of each graveyard"><i class="fa-solid fa-leaf"></i> Carbon/Ha</button>
            <button class="mode-btn" onclick="setMode('agb')" title="Above Ground Biomass Total (tonnes) - Total carbon stored in vegetation"><i class="fa-solid fa-seedling"></i> AGB Total</button>
            <button class="mode-btn" onclick="setMode('canopy')" title="Canopy Cover Percentage - Tree canopy coverage of each site"><i class="fa-solid fa-cloud"></i> Canopy %</button>
            <button class="mode-btn" onclick="setMode('edi')" title="Environmental Deprivation Index - Measures environmental quality (higher = better)"><i class="fa-solid fa-tree"></i> EDI</button>
            <button class="mode-btn" onclick="setMode('ndvi')" title="Normalized Difference Vegetation Index - Satellite-derived vegetation greenness (0-1)"><i class="fa-solid fa-spa"></i> NDVI</button>
            <button class="mode-btn" onclick="setMode('simd')" title="Scottish Index of Multiple Deprivation - Neighbourhood deprivation level (1=most deprived, 10=least)"><i class="fa-solid fa-house-user"></i> SIMD</button>
            <button class="mode-btn" onclick="setMode('strata')" title="Vegetation Strata Classification - High/Medium/Low tree coverage category"><i class="fa-solid fa-layer-group"></i> Strata</button>
        </div>

        <!-- Edinburgh SIMD Background Toggle -->
        <div style="padding: 15px 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">City-wide SIMD</div>
            <button id="simd-bg-btn" onclick="toggleSIMDBackground()" title="Toggle city-wide SIMD background layer showing neighbourhood deprivation across Edinburgh" style="width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;">
                <i class="fa-solid fa-layer-group"></i> Edinburgh Deprivation Map
            </button>
        </div>

        <!-- Advanced Filters -->
        <div style="padding: 15px 20px; border-bottom: 1px solid var(--border);">
            <div style="font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 10px; font-weight: 600;">Advanced Filters</div>
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 6px;">Carbon Range (t)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="carbon-min" value="0" style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;">
                    <span style="color: #64748b;">-</span>
                    <input type="number" id="carbon-max" value="200" style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px;">
                </div>
            </div>
            <button onclick="applyFilters()" style="width: 100%; padding: 8px; background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">Apply Filters</button>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">35</div>
                <div class="stat-label">Total Sites</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-carbon">--</div>
                <div class="stat-label">Total Carbon (t)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-edi">--</div>
                <div class="stat-label">Avg EDI</div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="search-input" placeholder="Search graveyards..." oninput="filterList()">
        </div>

        <!-- List Container -->
        <div class="list-container" id="list"></div>

        <!-- Simulator Panel -->
        <div class="simulator" id="sim-panel" style="display:none;">
            <div class="sim-title"><i class="fa-solid fa-tree"></i> Investment Simulator</div>
            <div style="font-size:11px; margin-bottom:5px;">Increase Canopy by: <span id="sim-val" style="color:var(--neon-green)">0%</span></div>
            <input type="range" min="0" max="50" value="0" oninput="updateSim(this.value)">
            <div style="font-size:11px; color:#94a3b8; margin-top:5px;">Projected Carbon: <span id="sim-result">--</span></div>
        </div>
    </div>

    <div id="map-page">
        <div id="map"></div>

        <!-- Legend on Map -->
        <div class="map-legend" id="map-legend">
            <div class="map-legend-title">Legend</div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-1" style="background: #059669;"></div>
                <span id="legend-map-1-text">High</span>
            </div>
            <div class="legend-item-map" id="legend-item-2" style="display: none;">
                <div class="legend-color-map" id="legend-map-2" style="background: #10b981;"></div>
                <span id="legend-map-2-text">Medium-High</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-3" style="background: #10b981;"></div>
                <span id="legend-map-3-text">Medium</span>
            </div>
            <div class="legend-item-map" id="legend-item-4" style="display: none;">
                <div class="legend-color-map" id="legend-map-4" style="background: #6ee7b7;"></div>
                <span id="legend-map-4-text">Medium-Low</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" id="legend-map-5" style="background: #6ee7b7;"></div>
                <span id="legend-map-5-text">Low</span>
            </div>
        </div>

        <!-- SIMD Background Legend -->
        <div class="map-legend" id="simd-legend" style="display: none; bottom: 250px;">
            <div class="map-legend-title">SIMD Deprivation</div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #ef4444;"></div>
                <span>Most Deprived (1-2)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #f97316;"></div>
                <span>High (3-4)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #fbbf24;"></div>
                <span>Medium (5-6)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #84cc16;"></div>
                <span>Low (7-8)</span>
            </div>
            <div class="legend-item-map">
                <div class="legend-color-map" style="background: #22c55e;"></div>
                <span>Least Deprived (9-10)</span>
            </div>
        </div>
    </div>

    <!-- Report Page -->
    <div id="report-page">
        <!-- Report Navigation -->
        <nav class="report-nav" id="reportNav">
            <div class="report-nav-inner">
                <div class="report-logo">
                    <img src="/dev/group1project/static/report_images/University_of_Edinburgh_Coat_of_Arm.png" alt="University of Edinburgh">
                    <span class="report-logo-text">Carbon Research</span>
                </div>
                <div class="report-nav-links">
                    <a href="#report-intro">Introduction</a>
                    <a href="#report-methods">Methods</a>
                    <a href="#report-results">Results</a>
                    <a href="#report-conclusions">Conclusions</a>
                    <a href="#report-team">Team</a>
                    <a href="#" onclick="switchPage('map'); return false;" style="color: var(--neon-blue);">Interactive Map</a>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="report-hero">
            <div class="report-hero-content">
                <h1>Dead Space?</h1>
                <p class="subtitle">What graveyards tell us about carbon and communities</p>
                <div style="display: flex; justify-content: space-between; gap: 30px; margin-top: 40px; width: 100%; padding: 0 40px;">
                    <img src="/dev/group1project/static/report_images/image3.jpg" alt="Graveyard 1" loading="lazy" style="flex: 1; width: 33%; height: auto; object-fit: cover; border-radius: 12px; cursor: pointer;" onclick="openImageModal(this.src)">
                    <img src="/dev/group1project/static/report_images/image1.jpg" alt="Graveyard 2" loading="lazy" style="flex: 1; width: 33%; height: auto; object-fit: cover; border-radius: 12px; cursor: pointer;" onclick="openImageModal(this.src)">
                    <img src="/dev/group1project/static/report_images/image7.jpg" alt="Graveyard 3" loading="lazy" style="flex: 1; width: 33%; height: auto; object-fit: cover; border-radius: 12px; cursor: pointer;" onclick="openImageModal(this.src)">
                </div>
            </div>
        </section>

        <!-- Key Findings -->
        <section id="report-intro" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Key <span>Findings</span></h2>
                <div class="report-key-points">
                    <div class="report-key-point">
                        <i class="fas fa-tree"></i>
                        <h4>35 Graveyards</h4>
                        <p>Public cemeteries examined across Edinburgh for carbon storage potential</p>
                    </div>
                    <div class="report-key-point">
                        <i class="fas fa-chart-line"></i>
                        <h4>Large Bias</h4>
                        <p>Mean Error: 71.54 Mg/ha, exceeding UK woodland average</p>
                    </div>
                    <div class="report-key-point">
                        <i class="fas fa-map-marker-alt"></i>
                        <h4>Limited Overlap</h4>
                        <p>Environmental and social deprivation measures show minimal alignment</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Study Area -->
        <section class="report-section">
            <div class="report-container">
                <div class="report-content-card">
                    <div class="report-card-image">
                        <img src="/dev/group1project/static/report_images/image2.png" alt="Study Area">
                    </div>
                    <div class="report-card-content">
                        <h3>Study Area</h3>
                        <p>Edinburgh's graveyards represent a unique yet understudied subset of greenspaces with great potential as carbon vaults.</p>
                        <ul>
                            <li>35 publicly accessible graveyards examined</li>
                            <li>Conducted for CSGN and City of Edinburgh Council</li>
                            <li>Focus on above-ground carbon storage</li>
                            <li>Goal: Identify priority sites for greenspace investment</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Methods -->
        <section id="report-methods" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Methods</span></h2>
                <div class="report-content-card" style="grid-template-columns: 1fr; gap: 20px;">
                    <div class="report-card-content" style="padding: 30px;">
                        <h3>Fieldwork & Data Collection</h3>
                        <p>Ground data collected from 5-8 November using stratified random sampling across nine graveyards representing low, medium, and high tree coverage.</p>
                        <ul>
                            <li>63 plots surveyed (5m radius each)</li>
                            <li>Tree species, condition, and DBH recorded</li>
                            <li>LiDAR-derived canopy height model (0.5m resolution)</li>
                            <li>Sentinel-2 NDVI for vegetation greenness</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 20px; padding: 0 30px 30px;">
                        <img src="/dev/group1project/static/report_images/image1.jpg" alt="Fieldwork" style="width: 50%; height: auto; object-fit: contain; border-radius: 8px; cursor: pointer;" onclick="openImageModal(this.src)">
                        <img src="/dev/group1project/static/report_images/image3.jpg" alt="Fieldwork 2" style="width: 50%; height: auto; object-fit: contain; border-radius: 8px; cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                </div>
                <div class="report-stats">
                    <div class="report-stat">
                        <div class="report-stat-value">63</div>
                        <div class="report-stat-label">Survey Plots</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">9</div>
                        <div class="report-stat-label">Graveyards Sampled</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">0.5m</div>
                        <div class="report-stat-label">LiDAR Resolution</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value">70%</div>
                        <div class="report-stat-label">Calibration Data</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results -->
        <section id="report-results" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Results</span></h2>
                <div class="report-content-card">
                    <div class="report-card-image">
                        <img src="/dev/group1project/static/report_images/image12.png" alt="Carbon Estimation" style="cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                    <div class="report-card-content">
                        <h3>Carbon Estimation Models</h3>
                        <p>Scatterplots showing calibration and validation of LiDAR-derived carbon estimates. Both models show weak positive relationships between canopy height and carbon density.</p>
                        <ul>
                            <li>Calibration Mean Error: 71.54 Mg/ha</li>
                            <li>Validation Mean Error: 68.23 Mg/ha</li>
                            <li>RMSE values exceed UK woodland average (53.6 Mg/ha)</li>
                            <li>Results indicate systematic overestimation</li>
                        </ul>
                    </div>
                </div>
                <div class="report-content-card reverse">
                    <div class="report-card-image">
                        <img src="/dev/group1project/static/report_images/image14.png" alt="Deprivation Analysis" style="cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                    <div class="report-card-content">
                        <h3>Deprivation Analysis</h3>
                        <p>Overlaying Environmental Deprivation Index (EDI) scores with SIMD 2020 neighbourhood ranks reveals spatial patterns of environmental and social deprivation.</p>
                        <ul>
                            <li>Darker colours indicate greater deprivation</li>
                            <li>Craigmillar Castle Park in high social deprivation cluster</li>
                            <li>EDI scores generally conform to tree cover</li>
                            <li>Notable exception: grassy areas ranked with leafy counterparts</li>
                        </ul>
                    </div>
                </div>
                <div class="report-content-card">
                    <div class="report-card-image">
                        <img src="/dev/group1project/static/report_images/image15.png" alt="Spatial Cluster Analysis" style="cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                    <div class="report-card-content">
                        <h3>Spatial Cluster Analysis</h3>
                        <p>Anselin Local Moran's I analysis identifies neighbourhood clusters and outliers of social deprivation, with EDI values highlighting environmentally deprived graveyards.</p>
                        <ul>
                            <li>No top-15 environmentally-deprived sites in social hotspots</li>
                            <li>Only Buccleuch in significant social-deprivation outlier</li>
                            <li>Limited alignment between two deprivation measures</li>
                            <li>SIMD provides more fruitful short-term approach</li>
                        </ul>
                    </div>
                </div>
                <div class="report-content-card" style="grid-template-columns: 1fr; gap: 20px;">
                    <div class="report-card-content" style="padding: 30px;">
                        <h3>Beyond Carbon Storage</h3>
                        <p>Field observations revealed graveyards deliver cultural, quality of life and biodiversity value beyond just carbon storage.</p>
                        <ul>
                            <li>Benches, bird boxes, and beehives observed</li>
                            <li>334 species recorded in Grange Cemetery alone</li>
                            <li>Tourist-historic value (e.g., Greyfriars Bobby)</li>
                            <li>Recreational and tranquil greenspace benefits</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 20px; padding: 0 30px 30px;">
                        <img src="/dev/group1project/static/report_images/image19.jpg" alt="Beyond Carbon Storage" style="width: 50%; height: auto; object-fit: contain; border-radius: 8px; cursor: pointer;" onclick="openImageModal(this.src)">
                        <img src="/dev/group1project/static/report_images/image20.jpg" alt="Beyond Carbon Storage 2" style="width: 50%; height: auto; object-fit: contain; border-radius: 8px; cursor: pointer;" onclick="openImageModal(this.src)">
                    </div>
                </div>
            </div>
        </section>

        <!-- Conclusions -->
        <section id="report-conclusions" class="report-section" style="background: #f1f3f5;">
            <div class="report-container">
                <h2 class="report-section-title">Conclusions & <span>Recommendations</span></h2>
                <p style="text-align: center; max-width: 700px; margin: 0 auto 40px; color: #2d3436;">
                    Carbon estimates cannot be considered reliable. EDI is not yet suitable for targeting priority areas. However, graveyards provide valuable benefits uncaptured by current metrics.
                </p>
                <div class="report-recommendations">
                    <div class="report-rec-item">
                        <div class="report-rec-number">1</div>
                        <div class="report-rec-content">
                            <h4>Prioritise Social Deprivation Hotspots</h4>
                            <p>Short-term funding should highlight sites in SIMD clusters as high-impact opportunities for greenspace protection and enhancement.</p>
                        </div>
                    </div>
                    <div class="report-rec-item">
                        <div class="report-rec-number">2</div>
                        <div class="report-rec-content">
                            <h4>Develop Broader Environmental Index</h4>
                            <p>Incorporate accessibility to greenspace and ecosystem services to better represent lived experience. Validate with reliable ground data.</p>
                        </div>
                    </div>
                    <div class="report-rec-item">
                        <div class="report-rec-number">3</div>
                        <div class="report-rec-content">
                            <h4>Combine Multiple Datasets</h4>
                            <p>Use spatial analysis of SIMD with environmental data as a long-term method for identifying communities impacted by multiple deprivations.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Team -->
        <section id="report-team" class="report-section" style="background: #fff;">
            <div class="report-container">
                <h2 class="report-section-title">Research <span>Team</span></h2>
                <div class="report-team-grid">
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Alex Shaw.png" alt="Alex Shaw">
                        <h4>Alex Shaw</h4>
                        <p>Researcher</p>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Charlotte Thomson" alt="Charlotte Thomson">
                        <h4>Charlotte Thomson</h4>
                        <p>Researcher</p>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Lama Alqahtani" alt="Lama Alqahtani">
                        <h4>Lama Alqahtani</h4>
                        <p>Researcher</p>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Ollie Cavil" alt="Ollie Cavill">
                        <h4>Ollie Cavill</h4>
                        <p>Researcher</p>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Wu Xinxin" alt="Wu Xinxin">
                        <h4>Wu Xinxin</h4>
                        <p>Researcher</p>
                    </div>
                    <div class="report-team-member">
                        <img class="report-team-avatar-img" src="/dev/group1project/static/report_images/Xiao Lang" alt="Xiao Lang">
                        <h4>Xiao Lang</h4>
                        <p>Researcher</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="report-footer">
            <div class="report-footer-inner">
                <!-- Logo Left -->
                <div class="report-footer-brand">
                    <img src="/dev/group1project/static/report_images/University_of_Edinburgh_Coat_of_Arm.png" alt="University of Edinburgh" style="height: 250px;">
                </div>
                <!-- Content Right -->
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                    <div style="font-size: 12px; opacity: 0.7; text-align: right;">
                        &copy; 2025 University of Edinburgh. All rights reserved.<br>
                        <span style="font-size: 10px;">Data: Scottish Government SIMD 2020, Scottish Remote Sensing Portal LiDAR, ESA Sentinel-2</span>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <a href="https://github.com/langxiao323" target="_blank" style="color: #fff; font-size: 20px; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="View Project on GitHub"><i class="fab fa-github"></i></a>
                        <a href="mailto:s2835812@ed.ac.uk" style="color: #fff; font-size: 20px; opacity: 0.7; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="Contact Us"><i class="fas fa-envelope"></i></a>
                        <span style="font-size: 13px; opacity: 0.8; margin-left: 10px;">Developed by <strong>Group 1</strong> | MSc GIS 2025</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: pointer;" onclick="closeImageModal()">
        <img id="modalImage" src="" alt="Enlarged Image" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
        <span style="position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer;">&times;</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // Page switching function
        function switchPage(page) {
            if (page === 'map') {
                document.getElementById('map-page').classList.add('active');
                document.getElementById('report-page').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('btn-map').style.background = 'rgba(14, 165, 233, 0.2)';
                document.getElementById('btn-map').style.borderColor = 'var(--neon-blue)';
                document.getElementById('btn-map').style.color = 'var(--neon-blue)';
                document.getElementById('btn-report').style.background = 'rgba(139, 92, 246, 0.1)';
                document.getElementById('btn-report').style.borderColor = 'rgba(139, 92, 246, 0.5)';
                document.getElementById('btn-report').style.color = 'rgba(139, 92, 246, 0.7)';
                if (document.getElementById('btn-map-from-report')) {
                    document.getElementById('btn-map-from-report').classList.add('active');
                    document.getElementById('btn-report-from-report').classList.remove('active');
                }
                window.scrollTo(0, 0);
                // Invalidate map size after showing
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            } else if (page === 'report') {
                document.getElementById('map-page').classList.remove('active');
                document.getElementById('report-page').classList.remove('hidden');
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('btn-map').style.background = 'rgba(14, 165, 233, 0.1)';
                document.getElementById('btn-map').style.borderColor = 'rgba(14, 165, 233, 0.5)';
                document.getElementById('btn-map').style.color = 'rgba(14, 165, 233, 0.7)';
                document.getElementById('btn-report').style.background = 'rgba(14, 165, 233, 0.2)';
                document.getElementById('btn-report').style.borderColor = 'var(--neon-blue)';
                document.getElementById('btn-report').style.color = 'var(--neon-blue)';
                if (document.getElementById('btn-map-from-report')) {
                    document.getElementById('btn-map-from-report').classList.remove('active');
                    document.getElementById('btn-report-from-report').classList.add('active');
                }
                window.scrollTo(0, 0);
            }
        }

        // Hide sidebar on page load (default to report page)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sidebar').classList.add('hidden');
        });

        // Image modal functions
        function openImageModal(src) {
            var modal = document.getElementById('imageModal');
            var modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function submitFeedback(event) {
            event.preventDefault();
            var form = document.getElementById('feedbackForm');
            var message = document.getElementById('feedbackMessage');
            message.style.display = 'block';
            message.style.color = '#10b981';
            message.textContent = 'Thank you for your feedback!';
            form.reset();
            setTimeout(function() {
                message.style.display = 'none';
            }, 3000);
        }

        // Back to Top Button visibility
        window.addEventListener('scroll', function() {
            var backToTop = document.getElementById('backToTop');
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });

        var map = L.map('map', {
            zoomControl: false
        }).setView([55.9533, -3.1883], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        var geojsonLayer;
        var rawData;
        var currentMode = 'carbon';
        var selectedFeature = null;
        var routingControl = null;
        var simdLayer = null;
        var showSIMDBackground = false;

        // SIMD background layer style
        function getSIMDStyle(feature) {
            var rank = feature.properties.SIMD_Rank;
            var decile = feature.properties.SIMD_Decile;
            var color = '#94a3b8';

            // Color by decile (1=most deprived, 10=least deprived)
            if (decile <= 2) color = '#ef4444'; // Red - most deprived
            else if (decile <= 4) color = '#f97316'; // Orange
            else if (decile <= 6) color = '#fbbf24'; // Yellow
            else if (decile <= 8) color = '#84cc16'; // Light green
            else color = '#22c55e'; // Green - least deprived

            return {
                fillColor: color,
                weight: 0.5,
                opacity: 0.5,
                color: '#333',
                fillOpacity: 0.4
            };
        }

        // Toggle SIMD background layer
        function toggleSIMDBackground() {
            showSIMDBackground = !showSIMDBackground;
            if (simdLayer) {
                if (showSIMDBackground) {
                    simdLayer.addTo(map);
                    simdLayer.bringToBack();
                } else {
                    map.removeLayer(simdLayer);
                }
            }
            // Update button style
            var btn = document.getElementById('simd-bg-btn');
            if (btn) {
                btn.style.background = showSIMDBackground ? 'rgba(239, 68, 68, 0.5)' : 'rgba(239, 68, 68, 0.2)';
            }
            // Toggle SIMD legend visibility
            var simdLegend = document.getElementById('simd-legend');
            if (simdLegend) {
                simdLegend.style.display = showSIMDBackground ? 'block' : 'none';
            }
        }

        function getStyle(feature) {
            var p = feature.properties;
            var color = '#94a3b8';
            var opacity = 0.5;

            if (currentMode === 'carbon') {
                // Carbon per hectare: yellow-green to dark green (high contrast)
                var c = p.CarbonPerHectare || 0;
                if (c > 120) color = '#065f46'; // Very dark green
                else if (c > 80) color = '#059669'; // Dark green
                else if (c > 40) color = '#10b981'; // Medium green
                else color = '#bef264'; // Yellow-green (very visible)
            } else if (currentMode === 'agb') {
                // AGB Total: yellow-green to dark green
                var agb = p.AGBTotal || 0;
                if (agb > 100) color = '#065f46'; // Very dark green
                else if (agb > 50) color = '#059669'; // Dark green
                else if (agb > 20) color = '#10b981'; // Medium green
                else color = '#bef264'; // Yellow-green
            } else if (currentMode === 'edi') {
                // EDI: 0-45 range (actual data range), yellow-green to dark green
                var edi = p.EDI || 0;
                if (edi >= 30) color = '#065f46'; // Very dark green (high EDI)
                else if (edi >= 20) color = '#059669'; // Dark green
                else if (edi >= 10) color = '#10b981'; // Medium green
                else color = '#bef264'; // Yellow-green (low EDI)
            } else if (currentMode === 'ndvi') {
                // NDVI: 0-1 range, yellow to dark green
                var ndvi = p.NDVI || 0;
                if (ndvi >= 0.4) color = '#065f46'; // Very dark green
                else if (ndvi >= 0.3) color = '#059669'; // Dark green
                else if (ndvi >= 0.2) color = '#10b981'; // Medium green
                else color = '#fbbf24'; // Yellow (low vegetation)
            } else if (currentMode === 'canopy') {
                // Canopy Percentage: 0-100%, yellow-green to dark green
                var canopy = p.Canopy || 0;
                if (canopy >= 70) color = '#065f46'; // Very dark green
                else if (canopy >= 50) color = '#059669'; // Dark green
                else if (canopy >= 30) color = '#10b981'; // Medium green
                else color = '#bef264'; // Yellow-green
            } else if (currentMode === 'simd') {
                // SIMD: 5-level classification matching background layer
                if (p.SIMD <= 2) color = '#ef4444'; // Red - most deprived
                else if (p.SIMD <= 4) color = '#f97316'; // Orange
                else if (p.SIMD <= 6) color = '#fbbf24'; // Yellow
                else if (p.SIMD <= 8) color = '#84cc16'; // Light green
                else color = '#22c55e'; // Green - least deprived
            } else if (currentMode === 'strata') {
                // Strata: yellow-green to dark green
                if (p.Strata === 'High') color = '#065f46'; // Very dark green
                else if (p.Strata === 'Medium') color = '#10b981'; // Medium green
                else color = '#bef264'; // Yellow-green
            }

            return {
                fillColor: color,
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: opacity
            };
        }

        function updateLegend() {
            // Hide extra legend items by default
            document.getElementById('legend-item-2').style.display = 'none';
            document.getElementById('legend-item-4').style.display = 'none';

            if (currentMode === 'carbon') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#bef264';
                document.getElementById('legend-map-1-text').textContent = '>120 t/ha';
                document.getElementById('legend-map-3-text').textContent = '40-120 t/ha';
                document.getElementById('legend-map-5-text').textContent = '<40 t/ha';
            } else if (currentMode === 'agb') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#bef264';
                document.getElementById('legend-map-1-text').textContent = '>100 t';
                document.getElementById('legend-map-3-text').textContent = '20-100 t';
                document.getElementById('legend-map-5-text').textContent = '<20 t';
            } else if (currentMode === 'edi') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#bef264';
                document.getElementById('legend-map-1-text').textContent = 'High (>30)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (10-30)';
                document.getElementById('legend-map-5-text').textContent = 'Low (<10)';
            } else if (currentMode === 'ndvi') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#fbbf24';
                document.getElementById('legend-map-1-text').textContent = 'High (>0.4)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (0.2-0.4)';
                document.getElementById('legend-map-5-text').textContent = 'Low (<0.2)';
            } else if (currentMode === 'canopy') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#bef264';
                document.getElementById('legend-map-1-text').textContent = 'Dense (>70%)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (30-70%)';
                document.getElementById('legend-map-5-text').textContent = 'Sparse (<30%)';
            } else if (currentMode === 'simd') {
                // SIMD mode: show all 5 legend items
                document.getElementById('legend-item-2').style.display = 'flex';
                document.getElementById('legend-item-4').style.display = 'flex';
                document.getElementById('legend-map-1').style.background = '#22c55e';
                document.getElementById('legend-map-2').style.background = '#84cc16';
                document.getElementById('legend-map-3').style.background = '#fbbf24';
                document.getElementById('legend-map-4').style.background = '#f97316';
                document.getElementById('legend-map-5').style.background = '#ef4444';
                document.getElementById('legend-map-1-text').textContent = 'Least Deprived (9-10)';
                document.getElementById('legend-map-2-text').textContent = 'Low (7-8)';
                document.getElementById('legend-map-3-text').textContent = 'Medium (5-6)';
                document.getElementById('legend-map-4-text').textContent = 'High (3-4)';
                document.getElementById('legend-map-5-text').textContent = 'Most Deprived (1-2)';
            } else if (currentMode === 'strata') {
                document.getElementById('legend-map-1').style.background = '#065f46';
                document.getElementById('legend-map-3').style.background = '#10b981';
                document.getElementById('legend-map-5').style.background = '#bef264';
                document.getElementById('legend-map-1-text').textContent = 'High';
                document.getElementById('legend-map-3-text').textContent = 'Medium';
                document.getElementById('legend-map-5-text').textContent = 'Low';
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateLegend();
            geojsonLayer.setStyle(getStyle);
            renderList();
        }

        function getLayerByFeature(f) {
            var found = null;
            geojsonLayer.eachLayer(l => {
                if (l.feature === f) found = l;
            });
            return found;
        }

        function updateSim(percent) {
            document.getElementById('sim-val').innerText = `+${percent}%`;
            if (selectedFeature) {
                var currentC = parseFloat(selectedFeature.properties.CarbonPerHectare || 0);
                var projected = currentC * (1 + percent / 100);
                document.getElementById('sim-result').innerText = `${projected.toFixed(1)} t/ha`;
            }
        }

        function renderList() {
            var container = document.getElementById('list');
            container.innerHTML = '';

            // Sort based on current mode
            var sorted = [...rawData.features].sort((a, b) => {
                if (currentMode === 'carbon') return b.properties.CarbonPerHectare - a.properties.CarbonPerHectare;
                if (currentMode === 'agb') return b.properties.AGBTotal - a.properties.AGBTotal;
                if (currentMode === 'edi') return b.properties.EDI - a.properties.EDI;
                if (currentMode === 'ndvi') return b.properties.NDVI - a.properties.NDVI;
                if (currentMode === 'canopy') return b.properties.Canopy - a.properties.Canopy;
                if (currentMode === 'simd') return a.properties.SIMD - b.properties.SIMD;
                return 0;
            });

            sorted.forEach(f => {
                var p = f.properties;
                if (!p.has_data) return;
                var el = document.createElement('div');
                el.className = 'list-item';

                // Display value based on current mode
                var valueDisplay = '';
                if (currentMode === 'carbon') valueDisplay = `${p.CarbonPerHectare ? p.CarbonPerHectare.toFixed(1) : '0'} t/ha`;
                else if (currentMode === 'agb') valueDisplay = `${p.AGBTotal ? p.AGBTotal.toFixed(1) : '0'} t`;
                else if (currentMode === 'edi') valueDisplay = `EDI: ${p.EDI ? p.EDI.toFixed(1) : '0'}`;
                else if (currentMode === 'ndvi') valueDisplay = `NDVI: ${p.NDVI ? p.NDVI.toFixed(3) : '0'}`;
                else if (currentMode === 'canopy') valueDisplay = `${p.Canopy ? p.Canopy.toFixed(1) : '0'}%`;
                else if (currentMode === 'simd') valueDisplay = `SIMD: ${p.SIMD || 'N/A'}`;
                else if (currentMode === 'strata') valueDisplay = p.Strata || 'N/A';

                // Generate tags with appropriate classes
                var tagsHtml = (p.ReportTags || []).map(t => {
                    var tagClass = 'tag';
                    if (t.includes('Priority')) tagClass += ' priority';
                    if (t.includes('Biodiversity') || t.includes('Species')) tagClass += ' biodiversity';
                    if (t.includes('Heritage') || t.includes('Monument') || t.includes('Tourist')) tagClass += ' heritage';
                    if (t.includes('Highest')) tagClass += ' highest';
                    return `<span class="${tagClass}">${t}</span>`;
                }).join(' ');

                // Add special class for priority/highest EDI sites
                var specialClass = '';
                if ((p.ReportTags || []).some(t => t.includes('Priority'))) specialClass = 'priority-site';
                if ((p.ReportTags || []).some(t => t.includes('Highest'))) specialClass = 'highest-edi';

                el.className = `list-item ${specialClass}`;
                el.innerHTML = `
                <div class="item-header">
                    <span>${p.name}</span>
                    <span style="color:${getStyle(f).fillColor}">${valueDisplay}</span>
                </div>
                <div class="item-sub"><span>SIMD: ${p.SIMD || 'N/A'}</span>${tagsHtml}</div>
            `;
                el.onclick = () => {
                    var layer = getLayerByFeature(f);
                    map.flyToBounds(layer.getBounds(), {
                        padding: [100, 100]
                    });
                    layer.fire('click');
                };
                container.appendChild(el);
            });
        }

        // Flickr API key (free tier)
        var FLICKR_API_KEY = '25506987f67f81e9a5ae6aa198fae3cf';

        function fetchWikiImage(name, imgElementId) {
            var cleanName = name.split('(')[0].trim();
            var searchTerm = cleanName + " Edinburgh cemetery";
            var searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${searchTerm}&format=json&origin=*`;
            var imgElement = document.getElementById(imgElementId);
            var imgContainer = imgElement ? imgElement.parentElement : null;

            // Try Wikipedia first
            fetch(searchUrl)
                .then(r => r.json())
                .then(data => {
                    if (data.query.search.length > 0) {
                        var pageTitle = data.query.search[0].title;
                        var imgUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${pageTitle}&prop=pageimages&format=json&pithumbsize=400&origin=*`;
                        return fetch(imgUrl);
                    } else {
                        throw new Error("No wiki page");
                    }
                })
                .then(r => r.json())
                .then(data => {
                    var pages = data.query.pages;
                    var pageId = Object.keys(pages)[0];
                    if (pages[pageId].thumbnail) {
                        imgElement.src = pages[pageId].thumbnail.source;
                    } else {
                        // No Wikipedia image, try Flickr
                        fetchFlickrImage(cleanName, imgElement, imgContainer);
                    }
                })
                .catch(e => {
                    // Wikipedia failed, try Flickr
                    fetchFlickrImage(cleanName, imgElement, imgContainer);
                });
        }

        function fetchFlickrImage(searchTerm, imgElement, imgContainer) {
            var flickrUrl = `https://www.flickr.com/services/rest/?method=flickr.photos.search&api_key=${FLICKR_API_KEY}&text=${encodeURIComponent(searchTerm + ' Edinburgh')}&sort=relevance&per_page=1&format=json&nojsoncallback=1`;

            fetch(flickrUrl)
                .then(r => r.json())
                .then(data => {
                    if (data.photos && data.photos.photo && data.photos.photo.length > 0) {
                        var photo = data.photos.photo[0];
                        // Construct Flickr image URL
                        var photoUrl = `https://live.staticflickr.com/${photo.server}/${photo.id}_${photo.secret}_w.jpg`;
                        imgElement.src = photoUrl;
                    } else {
                        // No Flickr image, hide container
                        if (imgContainer) imgContainer.style.display = 'none';
                    }
                })
                .catch(e => {
                    // Flickr failed, hide container
                    if (imgContainer) imgContainer.style.display = 'none';
                });
        }

        // Advanced Filters
        function applyFilters() {
            var carbonMin = parseFloat(document.getElementById('carbon-min').value) || 0;
            var carbonMax = parseFloat(document.getElementById('carbon-max').value) || 9999;

            var filteredCount = 0;

            geojsonLayer.eachLayer(layer => {
                var p = layer.feature.properties;
                var carbon = p.CarbonPerHectare || 0;

                if (carbon >= carbonMin && carbon <= carbonMax) {
                    layer.setStyle({
                        opacity: 1,
                        fillOpacity: 0.5
                    });
                    filteredCount++;
                } else {
                    layer.setStyle({
                        opacity: 0.2,
                        fillOpacity: 0.1
                    });
                }
            });

            alert(`Filters applied! Showing ${filteredCount} sites matching criteria.`);
            renderList();
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }


        // Export data
        function exportData() {
            if (!rawData) {
                alert('No data available to export');
                return;
            }

            const dataStr = JSON.stringify(rawData, null, 2);
            const dataBlob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'edinburgh_graveyards_data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Data exported successfully!');
        }

        // Search/Filter list
        function filterList() {
            var searchTerm = document.getElementById('search-input').value.toLowerCase();
            var items = document.querySelectorAll('.list-item');
            items.forEach(item => {
                var text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Load data from API - use relative path to adapt to deployment path
        var apiPath = window.location.pathname.replace(/\/$/, '') + '/api/graveyards';
        if (apiPath.startsWith('//')) apiPath = apiPath.substring(1);

        fetch(apiPath)
            .then(response => response.json())
            .then(data => {
                rawData = data;

                // Calculate statistics
                var totalCarbon = 0;
                var totalEDI = 0;
                var count = 0;
                data.features.forEach(f => {
                    if (f.properties.has_data) {
                        totalCarbon += f.properties.CarbonPerHectare || 0;
                        totalEDI += f.properties.EDI || 0;
                        count++;
                    }
                });

                document.getElementById('stat-carbon').textContent = totalCarbon.toFixed(1);
                document.getElementById('stat-avg-edi').textContent = (totalEDI / count).toFixed(1);

                // Add GeoJSON layer
                geojsonLayer = L.geoJSON(data, {
                    style: getStyle,
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function() {
                            selectedFeature = feature;
                            var p = feature.properties;
                            var imgId = 'popup-img-' + p.id;

                            var coords = layer.getBounds().getCenter();
                            var googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}`;

                            var popupContent = `
                            <div class="popup-img-container">
                                <img id="${imgId}" class="popup-img" src="https://images.unsplash.com/photo-1518709414768-a88981a4515d?q=80&w=600&auto=format&fit=crop" alt="${p.name}">
                            </div>
                            <div class="popup-info">
                                <h2 class="popup-header">${p.name}</h2>
                                <div class="popup-stats">
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Area</div>
                                        <div class="popup-stat-value" style="color: var(--neon-yellow);">${p.Area ? (p.Area / 10000).toFixed(2) : 'N/A'} ha</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Carbon/Ha</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.CarbonPerHectare ? p.CarbonPerHectare.toFixed(1) : 'N/A'} t/ha</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">AGB Total</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.AGBTotal ? p.AGBTotal.toFixed(1) : 'N/A'} t</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Canopy %</div>
                                        <div class="popup-stat-value" style="color: var(--neon-green);">${p.Canopy ? p.Canopy.toFixed(1) : 'N/A'}%</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">EDI Score</div>
                                        <div class="popup-stat-value" style="color: var(--neon-blue);">${p.EDI ? p.EDI.toFixed(1) : 'N/A'}</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">NDVI</div>
                                        <div class="popup-stat-value" style="color: var(--neon-blue);">${p.NDVI ? p.NDVI.toFixed(3) : 'N/A'}</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">SIMD Decile</div>
                                        <div class="popup-stat-value" style="color: var(--neon-purple);">${p.SIMD || 'N/A'}</div>
                                    </div>
                                    <div class="popup-stat">
                                        <div class="popup-stat-label">Strata</div>
                                        <div class="popup-stat-value">${p.Strata || 'N/A'}</div>
                                    </div>
                                </div>
                                <a href="${googleMapsUrl}" target="_blank" style="display: block; margin-top: 15px; padding: 10px; background: var(--neon-blue); color: #fff; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 13px;">
                                    <i class="fa-solid fa-location-arrow"></i> Navigate with Google Maps
                                </a>
                            </div>
                        `;

                            layer.bindPopup(popupContent, {
                                maxWidth: 320
                            }).openPopup();
                            fetchWikiImage(p.name, imgId);

                            // Show simulator panel
                            document.getElementById('sim-panel').style.display = 'block';
                        });
                    }
                }).addTo(map);

                // Add number labels to each graveyard
                var labelIndex = 1;
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.feature.properties.has_data) {
                        var center = layer.getBounds().getCenter();
                        var numberIcon = L.divIcon({
                            className: 'graveyard-number-label',
                            html: '<div class="number-marker">' + labelIndex + '</div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        var marker = L.marker(center, {
                            icon: numberIcon,
                            interactive: true
                        });
                        marker.on('click', function() {
                            map.flyToBounds(layer.getBounds(), {
                                padding: [100, 100]
                            });
                            layer.fire('click');
                        });
                        marker.addTo(map);
                        labelIndex++;
                    }
                });

                // Render list
                renderList();

                // Load SIMD background layer
                var simdApiPath = window.location.pathname.replace(/\/$/, '') + '/api/simd';
                if (simdApiPath.startsWith('//')) simdApiPath = simdApiPath.substring(1);

                fetch(simdApiPath)
                    .then(response => response.json())
                    .then(simdData => {
                        simdLayer = L.geoJSON(simdData, {
                            style: getSIMDStyle,
                            onEachFeature: function(feature, layer) {
                                layer.bindTooltip(
                                    `<b>${feature.properties.Name}</b><br>SIMD Rank: ${feature.properties.SIMD_Rank}<br>Decile: ${feature.properties.SIMD_Decile}`, {
                                        sticky: true
                                    }
                                );
                            }
                        });
                        console.log('SIMD layer loaded with ' + simdData.features.length + ' areas');
                    })
                    .catch(err => console.error('Error loading SIMD data:', err));

                // Hide loading
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '<div class="spinner"></div><div class="loading-text">Error loading data. Please refresh.</div>';
            });

        // Add zoom controls
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
    </script>
</body>

</html>