<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edinburgh Carbon Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.95);
            --neon-blue: #0ea5e9;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-purple: #8b5cf6;
            --text: #f1f5f9;
            --border: rgba(148, 163, 184, 0.2);
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .sidebar {
            position: absolute; top: 20px; left: 20px; bottom: 20px; width: 380px;
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--border); border-radius: 12px;
            z-index: 1000; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .header { padding: 20px; border-bottom: 1px solid var(--border); }
        .header h1 { font-family: 'Rajdhani'; margin: 0; font-size: 26px; text-transform: uppercase; background: linear-gradient(to right, #fff, var(--neon-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { margin: 5px 0 0; font-size: 12px; color: #94a3b8; }
        .controls { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; }
        .mode-btn { 
            flex: 1; padding: 8px; border: 1px solid var(--border); background: transparent; color: #94a3b8; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.3s;
        }
        .mode-btn.active { background: rgba(14, 165, 233, 0.2); color: var(--neon-blue); border-color: var(--neon-blue); }
        .priority-btn {
            width: 100%; margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.15); 
            border: 1px solid var(--neon-red); color: var(--neon-red); border-radius: 6px; cursor: pointer;
            font-family: 'Rajdhani'; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        .priority-btn:hover { background: rgba(239, 68, 68, 0.3); }
        .nav-box { padding: 15px 20px; border-bottom: 1px solid var(--border); }
        .input-group { display: flex; gap: 8px; }
        .nav-input { 
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); 
            color: #fff; padding: 8px; border-radius: 6px; outline: none; font-size: 13px;
        }
        .nav-action-btn { 
            background: var(--neon-blue); color: #000; border: none; padding: 0 12px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; 
        }
        .list-container { flex: 1; overflow-y: auto; padding: 10px 20px; }
        .list-item { 
            padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); 
            border-radius: 8px; border-left: 3px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.08); }
        .list-item.active { background: rgba(16, 185, 129, 0.1); border-left-color: var(--neon-green); }
        .item-header { display: flex; justify-content: space-between; font-weight: 600; font-size: 14px; }
        .item-sub { font-size: 11px; color: #94a3b8; margin-top: 4px; display: flex; gap: 10px; }
        .simulator { padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); }
        .sim-title { font-size: 12px; text-transform: uppercase; color: var(--neon-green); margin-bottom: 10px; }
        input[type=range] { width: 100%; accent-color: var(--neon-green); }
        .leaflet-popup-content-wrapper { 
            background: rgba(15, 23, 42, 0.95); 
            color: #fff; 
            border: 1px solid var(--neon-blue); 
            border-radius: 12px; 
            backdrop-filter: blur(10px); 
            padding: 0; 
            overflow: hidden;
        }
        .leaflet-popup-content { margin: 0; width: 260px !important; }
        .leaflet-popup-tip { background: rgba(15, 23, 42, 0.95); }
        .leaflet-container a.leaflet-popup-close-button { color: #fff; font-size: 18px; top: 5px; right: 5px; text-shadow: 0 0 5px black; }
        .popup-img-container {
            width: 100%; height: 140px; background: #000; position: relative;
            overflow: hidden; border-bottom: 1px solid var(--border);
        }
        .popup-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .popup-img:hover { transform: scale(1.1); }
        .popup-info { padding: 15px; }
        .tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .tag.priority { border-color: var(--neon-red); color: var(--neon-red); background: rgba(239, 68, 68, 0.1); }
        .leaflet-routing-container { background-color: #1e293b !important; color: #fff !important; border-radius: 8px; border: 1px solid var(--border); font-size: 12px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <h1>Carbon Intelligence</h1>
        <p>Report-Driven Spatial Analysis</p>
    </div>

    <div class="controls">
        <button class="mode-btn active" onclick="setMode('carbon')">Carbon View</button>
        <button class="mode-btn" onclick="setMode('edi')">Deprivation (EDI)</button>
    </div>
    
    <div style="padding: 0 20px;">
        <button class="priority-btn" onclick="showPrioritySites()">
            <i class="fa-solid fa-triangle-exclamation"></i> Show Priority Zones
        </button>
    </div>

    <div class="nav-box">
        <div style="font-size:11px; color:#94a3b8; margin-bottom:5px;">PLAN ROUTE TO SELECTED SITE</div>
        <div class="input-group">
            <input type="text" id="start-location" class="nav-input" placeholder="Enter start location">
            <button class="nav-action-btn" onclick="calculateRoute()"><i class="fa-solid fa-route"></i></button>
        </div>
    </div>

    <div class="list-container" id="list"></div>

    <div class="simulator" id="sim-panel" style="display:none;">
        <div class="sim-title"><i class="fa-solid fa-tree"></i> Investment Simulator</div>
        <div style="font-size:11px; margin-bottom:5px;">Increase Canopy by: <span id="sim-val" style="color:var(--neon-green)">0%</span></div>
        <input type="range" min="0" max="50" value="0" oninput="updateSim(this.value)">
        <div style="font-size:11px; color:#94a3b8; margin-top:5px;">Projected Carbon: <span id="sim-result">--</span></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    var map = L.map('map', { zoomControl: false }).setView([55.9533, -3.1883], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    var geojsonLayer;
    var rawData;
    var currentMode = 'carbon';
    var selectedFeature = null; 
    var routingControl = null;

    function getStyle(feature) {
        var p = feature.properties;
        var color = '#94a3b8';

        if (currentMode === 'carbon') {
            if (p.Strata === 'High') color = '#10b981';
            else if (p.Strata === 'Medium') color = '#facc15';
            else color = '#ef4444';
        } else if (currentMode === 'edi') {
            if (p.EDI < 0.3) color = '#ef4444';
            else if (p.EDI < 0.6) color = '#c084fc';
            else color = '#38bdf8';
        }

        return {
            fillColor: color, weight: 2, opacity: 1, color: 'white', 
            dashArray: '3', fillOpacity: 0.4
        };
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        geojsonLayer.setStyle(getStyle);
        renderList();
    }

    function showPrioritySites() {
        alert("Highlighting sites with combined Social & Environmental Deprivation");
        var target = rawData.features.find(f => f.properties.name.includes("Buccleuch"));
        if(target) {
            var latlngs = L.GeoJSON.coordsToLatLngs(target.geometry.coordinates, 1);
            var bounds = L.latLngBounds(latlngs);
            map.flyToBounds(bounds, { padding: [100,100], duration: 2 });
            setTimeout(() => {
                geojsonLayer.eachLayer(l => {
                    if(l.feature.properties.name === target.properties.name) l.fire('click');
                });
            }, 2000);
        }
    }

    function calculateRoute() {
        var startText = document.getElementById('start-location').value;
        if(!startText || !selectedFeature) {
            alert("Please select a cemetery on the map AND enter a start location.");
            return;
        }
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${startText}`)
            .then(res => res.json())
            .then(locs => {
                if(locs.length === 0) { alert("Location not found!"); return; }
                var startLat = locs[0].lat;
                var startLon = locs[0].lon;
                var layer = getLayerByFeature(selectedFeature);
                var endLat = layer.getBounds().getCenter().lat;
                var endLon = layer.getBounds().getCenter().lng;

                if(routingControl) map.removeControl(routingControl);
                routingControl = L.Routing.control({
                    waypoints: [L.latLng(startLat, startLon), L.latLng(endLat, endLon)],
                    lineOptions: { styles: [{color: '#0ea5e9', weight: 6}] },
                    createMarker: function() { return null; },
                    addWaypoints: false,
                    draggableWaypoints: false
                }).addTo(map);
            });
    }

    function getLayerByFeature(f) {
        var found = null;
        geojsonLayer.eachLayer(l => { if(l.feature === f) found = l; });
        return found;
    }

    function updateSim(percent) {
        document.getElementById('sim-val').innerText = `+${percent}%`;
        if(selectedFeature) {
            var currentC = parseFloat(selectedFeature.properties.Carbon);
            var projected = currentC * (1 + percent/100);
            document.getElementById('sim-result').innerText = `${projected.toFixed(1)} t`;
        }
    }

    function renderList() {
        var container = document.getElementById('list');
        container.innerHTML = '';
        var sorted = [...rawData.features].sort((a,b) => {
            if(currentMode === 'edi') return a.properties.EDI - b.properties.EDI;
            return b.properties.Carbon - a.properties.Carbon;
        });

        sorted.forEach(f => {
            var p = f.properties;
            if(!p.has_data) return;
            var el = document.createElement('div');
            el.className = 'list-item';
            var valueDisplay = currentMode === 'edi' ? `EDI: ${p.EDI.toFixed(2)}` : `${p.Carbon.toFixed(1)} t`;
            var tagsHtml = (p.ReportTags || []).map(t => `<span class="tag ${t.includes('Priority')?'priority':''}">${t}</span>`).join(' ');

            el.innerHTML = `
                <div class="item-header">
                    <span>${p.name}</span>
                    <span style="color:${getStyle(f).fillColor}">${valueDisplay}</span>
                </div>
                <div class="item-sub"><span>SIMD: ${p.SIMD || 'N/A'}</span>${tagsHtml}</div>
            `;
            el.onclick = () => {
                var layer = getLayerByFeature(f);
                map.flyToBounds(layer.getBounds(), { padding: [100,100] });
                layer.fire('click');
            };
            container.appendChild(el);
        });
    }

    function fetchWikiImage(name, imgElementId) {
        var cleanName = name.split('(')[0].trim();
        var searchTerm = cleanName + " Edinburgh";
        var searchUrl = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${searchTerm}&format=json&origin=*`;
        
        fetch(searchUrl)
            .then(r => r.json())
            .then(data => {
                if(data.query.search.length > 0) {
                    var pageTitle = data.query.search[0].title;
                    var imgUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${pageTitle}&prop=pageimages&format=json&pithumbsize=400&origin=*`;
                    return fetch(imgUrl);
                } else { throw new Error("No wiki page"); }
            })
            .then(r => r.json())
            .then(data => {
                var pages = data.query.pages;
                var pageId = Object.keys(pages)[0];
                if(pages[pageId].thumbnail) {
                    document.getElementById(imgElementId).src = pages[pageId].thumbnail.source;
                } else {
                    document.getElementById(imgElementId).src = "https://images.unsplash.com/photo-1518709414768-a88981a4515d?q=80&w=600&auto=format&fit=crop"; 
                }
            })
            .catch(e => {
                document.getElementById(imgElementId).src = "https://images.unsplash.com/photo-1518709414768-a88981a4515d?q=80&w=600&auto=format&fit=crop";
            });
    }

    fetch('api/graveyards')
        .then(res => res.json())
        .then(data => {
            rawData = data;
            
            geojsonLayer = L.geoJSON(data, {
                style: getStyle,
                onEachFeature: function(feature, layer) {
                    layer.on({
                        mouseover: e => { e.target.setStyle({ weight: 4, fillOpacity: 0.8 }); },
                        mouseout: e => { geojsonLayer.resetStyle(e.target); },
                        click: e => {
                            selectedFeature = feature;
                            var p = feature.properties;
                            document.getElementById('sim-panel').style.display = 'block';
                            updateSim(0);
                            document.querySelector('.list-item.active')?.classList.remove('active');
                            var imgId = "img-" + Math.random().toString(36).substr(2, 9);

                            var content = `
                                <div class="popup-img-container">
                                    <img id="${imgId}" class="popup-img" src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Loading...">
                                </div>
                                <div class="popup-info">
                                    <h3 style="margin:0; font-family:'Rajdhani'; font-size:20px; color:${getStyle(feature).fillColor}">${p.name}</h3>
                                    <p style="margin:10px 0; font-size:12px; color:#cbd5e1; line-height:1.6;">
                                        <i class="fa-solid fa-leaf" style="color:var(--neon-green)"></i> Carbon: <b>${p.Carbon.toFixed(1)} t</b><br>
                                        <i class="fa-solid fa-chart-line" style="color:var(--neon-purple)"></i> EDI Score: <b>${p.EDI ? p.EDI.toFixed(2) : 'N/A'}</b><br>
                                        <i class="fa-solid fa-users" style="color:var(--neon-blue)"></i> SIMD Decile: <b>${p.SIMD}</b>
                                    </p>
                                    ${p.ReportTags ? `<div style="margin-bottom:10px; font-size:10px;">${p.ReportTags.map(t=>`<span class="tag">${t}</span>`).join(' ')}</div>` : ''}
                                    <div style="font-size:10px; color:#64748b;"><i>Select "Navigate Here" from sidebar.</i></div>
                                </div>
                            `;
                            layer.bindPopup(content).openPopup();
                            fetchWikiImage(p.name, imgId);
                        }
                    });
                }
            }).addTo(map);

            if(data.features.length) map.fitBounds(geojsonLayer.getBounds());
            renderList();
        });
</script>
</body>
</html>